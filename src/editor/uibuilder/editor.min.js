!function(){"use strict";const e="127.0.0.1"===location.hostname,o=e?console.log:function(){};if(o("[uibuilder] DEBUG ON (because running on localhost)"),Object.entries||(Object.entries=function(e){for(var t=Object.keys(e),o=t.length,i=new Array(o);o--;)i[o]=[t[o],e[t[o]]];return i}),!Object.values){const D=Function.bind.call(Function.call,Array.prototype.reduce),R=Reflect.ownKeys,C=Function.bind.call(Function.call,Array.prototype.concat),L=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable);Object.values=function(o){return D(R(o),(e,t)=>C(e,"string"==typeof t&&L(o,t)?[o[t]]:[]),[])}}const i=432e3,n="Replace This With A Real Secret",r="blank",l={};var d=[],a=RED.settings.uibuilderInstances;const u={format:"html",folder:"src",fname:"index.html",fullscreen:!1};function t(i){if(""===i||"string"!=typeof i)return"No package";RED.notify("Starting removal of npm package "+i),$("i.spinner").show(),$.get("uibuilder/uibnpmmanage?cmd=remove&package="+i,function(e){!0===e.success?(console.log("[uibuilder:removePackageRow:get] PACKAGE REMOVED. ",i),RED.notify("Successfully uninstalled npm package "+i,"success"),d[i]&&delete d[i]):(console.log("[uibuilder:removePackageRow:get] ERROR ON PACKAGE REMOVAL ",e.result),RED.notify("FAILED to uninstall npm package "+i,"error"),$("#node-input-packageList").editableList("addItem",i)),$("i.spinner").hide()}).fail(function(e,t,o){return console.error("[uibuilder:removePackageRow:get] Error "+t,o),RED.notify("FAILED to uninstall npm package "+i,"error"),$("#node-input-packageList").editableList("addItem",i),$("i.spinner").hide(),"removePackageRow failed"})}function c(e){let t="text",o=e.split(".");if(""===o[0]&&o.shift(),1<o.length){var i=o.pop().toLowerCase().trim();switch(i){case"js":t="javascript";break;case"html":case"css":case"json":t=i;break;case"vue":t="html";break;case"md":t="markdown";break;case"yaml":case"yml":t="yaml";break;default:t=i}}return t}function s(e){$("#edit-save").prop("disabled",e),$("#edit-reset").prop("disabled",e),$("#edit-close").prop("disabled",!e),$("#node-edit-file").prop("disabled",!e),$("#node-input-filename").prop("disabled",!e),$("#node-dialog-ok").prop("disabled",!e),$("#node-dialog-cancel").prop("disabled",!e),e?($("#node-dialog-ok").css("cursor","pointer"),$("#node-dialog-cancel").css("cursor","pointer")):($("#file-action-message").text("Save Required"),$("#node-dialog-ok").css("cursor","not-allowed"),$("#node-dialog-cancel").css("cursor","not-allowed"))}function p(){var e=$("#node-input-url").val(),t=$("#node-input-folder").val();null===t&&(t=localStorage.getItem("uibuilder."+e+".folder")||u.folder);var o=$("#node-input-filename").val();null===o&&(o=localStorage.getItem("uibuilder."+e+".selectedFile")||u.fname),u.folder=t,u.fname=o,localStorage.setItem("uibuilder."+e+".folder",u.folder),localStorage.setItem("uibuilder."+e+".selectedFile",u.fname);var i=u.format=c(o);$("#node-input-format").val(i),$.get("uibuilder/uibgetfile?url="+e+"&fname="+o+"&folder="+t,function(e){$("#node-input-template-editor").show(),$("#node-input-template-editor-no-file").hide(),u.editorSession.setValue(e),u.editorSession.setMode({path:"ace/mode/"+i,v:Date.now()}),u.editorSession.getUndoManager().isClean(),u.editor.focus()}).fail(function(e,t,o){console.error("[uibuilder:getFileContents:get] Error "+t,o),u.editorSession.setValue(""),$("#node-input-template-editor").hide(),$("#node-input-template-editor-no-file").show()}).always(function(){s(!0),$("#node-input-format option:selected").length||$("#node-input-format").val("text")})}function f(d){var a=$("#node-input-url").val(),s=$("#node-input-folder").val(),e=$("#node-input-filename").val();null===(d=void 0===d?e:d)&&(d=localStorage.getItem("uibuilder."+a+".selectedFile")||void 0),null===s&&(s=localStorage.getItem("uibuilder."+a+".folder")||void 0),$("#node-input-filename option").remove(),$("#node-input-folder option").remove(),$.ajax({type:"GET",dataType:"json",url:"./uibuilder/admin/"+a,data:{cmd:"listall"}}).done(function(e,t,o){let i="",n=!1,r=!1;var l=Object.keys(e).sort();$.each(l,function(e,t){""===t&&(t="root"),$("#node-input-folder").append($("<option>",{value:t,text:t}))}),e[s]||(s=e.src?"src":"root"),$("#node-input-folder").val(s),u.folder=s,localStorage.setItem("uibuilder."+a+".folder",s);e=e[s];$.each(e,function(e,t){$("#node-input-filename").append($("<option>",{value:t,text:t})),0===e&&(i=t),t===u.fname&&(n=!0),t===d&&(r=!0)}),!0===r?u.fname=d:!0===n?u.fname="index.html":u.fname=i,$("#node-input-filename").val(u.fname),u.format=c(u.fname),localStorage.setItem("uibuilder."+a+".selectedFile",u.fname)}).fail(function(e,t,o){console.error("[uibuilder:getFileList:getJSON] Error "+t,o),u.fname="",u.format="text",RED.notify("uibuilder: Folder and file listing error.<br>"+o,{type:"error"})}).always(function(){p()})}function b(){let e;if(!0===u.editorLoaded){if(document.fullscreenElement)$("#edit-props").css("background-color","#f6f6f6").css("padding","1em"),e=parseInt($("#edit-props").css("height"),10),e-=25,$("#node-function-expand-js").css("background-color","black").html('<i class="fa fa-compress"></i>'),u.fullscreen=!0;else{if("auto"===$("#edit-outer").css("top"))return;$("#edit-props").css("background-color","").css("padding",""),e=$(".red-ui-tray-footer").position().top-$("#edit-outer").offset().top-35,$("#node-function-expand-js").css("background-color","").html('<i class="fa fa-expand"></i>'),u.fullscreen=!1}for(var t=$("#edit-props > div:not(.node-text-editor-row)"),o=0;o<t.length;o++)e-=$(t[o]).outerHeight(!0);$("#node-input-template-editor").css("height",e+"px"),u.editor.resize()}}function h(e,t=!0){!0===t?($("#node-input-templateFolder, #btn-load-template").prop("disabled",!1).css({cursor:"auto"}),$("#red-ui-tab-tab-files, #red-ui-tab-tab-libraries, #red-ui-tab-tab-security, #red-ui-tab-tab-advanced, info").css({"pointer-events":"auto",cursor:"auto"}),$("#red-ui-tab-tab-files>a, #red-ui-tab-tab-libraries>a, #red-ui-tab-tab-security>a, #red-ui-tab-tab-advanced>a, info>a").css({color:"var(--nr-db-dark-text)",cursor:"auto"}),$("#uibuilderurl, #uibinstanceconf").css({"pointer-events":"auto","background-color":"",cursor:"auto"}),$("#url-errors").remove()):($("#node-input-templateFolder, #btn-load-template").prop("disabled",!0).css({cursor:"not-allowed"}),$("#red-ui-tab-tab-files, #red-ui-tab-tab-libraries, #red-ui-tab-tab-security, #red-ui-tab-tab-advanced, info").css({"pointer-events":"none",cursor:"not-allowed"}),$("#red-ui-tab-tab-files>a, #red-ui-tab-tab-libraries>a, #red-ui-tab-tab-security>a, #red-ui-tab-tab-advanced>a, info>a").css({color:"var(--nr-db-disabled-text)",cursor:"not-allowed"}),$("#uibuilderurl, #uibinstanceconf").css({"pointer-events":"none","background-color":"var(--red-ui-secondary-background-selected)",cursor:"not-allowed"}),$("#url-errors").remove(),$("#url-input").after(`
                <div id="url-errors" class="form-row" style="color:var(--red-ui-text-color-error)">
                    ${Object.values(e).join("<br>")} 
                </div>
            `))}function g(){var e,t=$("#node-input-templateFolder").val();if(RED.settings.uibuilderTemplates[t]){const o=RED.settings.uibuilderTemplates[t].dependencies||[],i=[];o.forEach(e=>{d[e]||i.push(e)}),0<i.length&&(e=RED.notify(`WARNING<br /><br />The selected uibuilder template (${t}) is MISSING the following dependencies:<div> ${i.join(", ")}</div><br />Please install them using the uibuilder Library Manager or select a different template.`,{type:"warning",modal:!0,fixed:!0,buttons:[{text:"OK",class:"primary",click:function(){e.close()}}]}))}else console.error("[uibuilder:checkDependencies] Template name not found: "+t)}function m(){var i=RED.notify(`WARNING<br /><br />
            Are you <b>SURE</b> you want to overwrite your code
            with the template <b><code>${$("#node-input-templateFolder").val()}</code></b>?<br /><br />
            <b>THIS CANNOT BE UNDONE.</b>`,{type:"warning",modal:!0,fixed:!0,buttons:[{text:"Cancel, don't overwrite",class:"primary",click:function(){i.close()}},{text:"OK, overwrite",click:function(){var e,t,o;e=$("#node-input-templateFolder").val(),t=$("#node-input-extTemplate").val(),o=$("#node-input-url").val(),$.ajax({type:"POST",dataType:"json",url:"./uibuilder/admin/"+o,data:{template:e,extTemplate:t,cmd:"replaceTemplate"}}).done(function(e,t,o){return RED.notify(`<b>uibuilder</b>:<br><br>${o.statusText}<br>`,{type:"success"}),"Template load succeeded"}).fail(function(e,t,o){return console.error("[uibuilder:loadTemplate] Error "+t,o),RED.notify(`<b>uibuilder</b>:<br><br>Template Load Error.<br><br>${o}<br>`,{type:"error"}),"Template load failed"}),i.close()}}]})}function v(e){$("#adv-templ").hide(),$("#show-templ-props").css("cursor","pointer"),$("#show-templ-props").on("click",function(){$("#adv-templ").toggle(),$("#adv-templ").is(":visible")?$("#show-templ-props").html('<i class="fa fa-caret-down"></i> Template Settings'):$("#show-templ-props").html('<i class="fa fa-caret-right"></i> Template Settings')}),function(e){let t=e.templateFolder,o=[];RED.settings&&RED.settings.uibuilderTemplates?o=RED.settings.uibuilderTemplates:console.error("[uibuilder:populateTemplateDropdown] Cannot access RED.settings for node "+e.id),Object.values(o).forEach(e=>{$("#node-input-templateFolder").append($("<option>",{value:e.folder,text:e.name}))}),o[t]||(t=r),$(`#node-input-templateFolder option[value="${t}"]`).prop("selected",!0),$("#node-input-templateFolder").val(t),$("#node-templSel-info").text(o[t].description),t}(e),g(),"external"===$("#node-input-templateFolder").val()&&$("#et-input").show(),$("#node-input-templateFolder").on("change",function(){RED.settings.uibuilderTemplates[e.templateFolder]&&$("#node-templSel-info").text(RED.settings.uibuilderTemplates[e.templateFolder].description),g(),"external"===$("#node-input-templateFolder").val()?$("#et-input").show():$("#et-input").hide()}),$("#btn-load-template").on("click",function(e){e.preventDefault(),m()})}function y(e){var t=$(this).val();const o=window.origin.split(":");let i=RED.settings.httpNodeRoot.replace(/^\//,"");$("#info-webserver").empty(),RED.settings.uibuilderCustomServer.port&&(o[0]=RED.settings.uibuilderCustomServer.type.replace("http2","https"),o[2]=RED.settings.uibuilderCustomServer.port,i="",$("#info-webserver").append(`<div class="form-tips node-help">uibuilder is using a custom webserver at ${o.join(":")+"/"} </div>`));var n=o.join(":")+"/";$("#uibuilderurl").prop("href",n+i+t).text("Open "+i+t),$("#uibinstanceconf").prop("href",`./uibuilder/instance/${t}?cmd=showinstancesettings`),$("#show-src-folder-idx-url").empty().append(`<div>at 
                    <a href="${n}${i}${$(this).val()}/idx" target="_blank" 
                            style="color:var(--red-ui-text-color-link);text-decoration:underline;">
                        ${i}${$(this).val()}/idx
                    </a>
                </div>`)}function w(){return $(".red-ui-tray-footer").position().top-$("#package-list-container").offset().top+25}function E(i){$("#node-input-packageList").editableList({addItem:function(e,t,o){!function(n,e,t,o){let i="",r;i=0===Object.entries(o).length?`
                <div>
                    <label for="packageList-input-${t}" style="width:3em;">Name:</label>
                    <input type="text" id="packageList-input-${t}" title="" style="width:80%" placeholder="Valid npm package name">
                </div>
                <div>
                    <label for="packageList-tag-${t}" style="width:3em;">Tag:</label>
                    <input type="text" id="packageList-tag-${t}" title="" style="width:80%" placeholder="npm: @tag/version, GH: #branch/tag">
                </div>
                <div>
                    <label for="packageList-button-${t}" style="width:3em;"></label>
                    <button id="packageList-button-${t}" style="width:5em;">Install</button>
                </div>
            `:(r=d[o],`
                <div id="packageList-row-${t}" class="packageList-row-data">
                    <a href="${r.homepage}" target="_blank" title="Click to open homepage in a new tab"><b>${o}</b></a>, <span title="${r.spec}">${r.installedVersion}</span>
                    <br>
                    URL to use: <code style="white-space:inherit;" title="NB: The actual resource is an estimate, check the package docs for the actual entry point">
                        ${r.url}
                    </code>
                </div>
            `),$(i).appendTo(e),0===Object.entries(o).length&&($("#packageList-input-"+t).tooltip({content:'Enter one of:<ul><li>An npm package name (optionally with leading)</li><li>A GitHub user/repo</li><li>A filing system path to a local package</li></ul>Ensure that you select the correct "From" dropdown.'}),$("#packageList-ver-"+t).tooltip({content:"Optional. Branch, Tag or Version to install (defaults to @latest)"})),$("#packageList-button-"+t).on("click",function(){$("i.spinner").show();var i=String($("#packageList-input-"+t).val()),e=String($("#packageList-tag-"+t).val());0!==i.length&&(RED.notify("Installing npm package "+i),$.get(`uibuilder/uibnpmmanage?cmd=install&package=${i}&url=${n.url}&tag=`+e,function(e){var t=e.result[0];!0===e.success?(d=e.result[1],console.log("[uibuilder:addPackageRow:get] PACKAGE INSTALLED. ",i,n.url,"\n\n",t,"\n "),RED.notify(`Successful installation of npm package ${i} for `+n.url,"success"),$("#node-input-packageList").editableList("empty"),$("#node-input-packageList").editableList("addItems",Object.keys(d))):(console.log("[uibuilder:addPackageRow:get] ERROR ON INSTALLATION OF PACKAGE ",i,n.url,"\n\n",t,"\n "),RED.notify(`FAILED installation of npm package ${i} for `+n.url,"error")),$("i.spinner").hide()}).fail(function(e,t,o){return console.error("[uibuilder:addPackageRow:get] Error "+t,o),RED.notify(`FAILED installation of npm package ${i} for `+n.url,"error"),$("i.spinner").hide(),"addPackageRow failed"}))})}(i,e,t,o)},removeItem:t,header:$("<div>").append("<b>Installed Packages</b>"),height:w(),addButton:!0,removable:!0,scrollOnAdd:!0,sortable:!1}),$("#node-input-packageList").editableList("empty"),$("#node-input-packageList").editableList("addItems",Object.keys(d)),$(".red-ui-editableList-addButton").after(' <i class="spinner"></i>'),$("i.spinner").hide()}function k(o){const e=RED.tabs.create({id:"tabs",scrollable:!1,collapsible:!1,onchange:function(e){switch($("#tabs-content").children().hide(),$("#"+e.id).show(),e.id){case"tab-files":t=o,f(),!0!==u.editorLoaded&&(""!==$("#node-input-template").val("")&&$("#node-input-template").val(""),u.editor=RED.editor.createEditor({id:"node-input-template-editor",mode:"ace/mode/"+u.format,value:t.template}),u.editorSession=u.editor.getSession(),u.editor.on("input",function(){s(u.editorSession.getUndoManager().isClean())}),u.editorLoaded=!0,b(),p(),s(!0));break;case"tab-libraries":E(o)}var t}});e.addTab({id:"tab-core",label:"Core"}),e.addTab({id:"tab-files",label:"Files"}),e.addTab({id:"tab-libraries",label:"Libraries"}),e.addTab({id:"tab-security",label:"Security"}),e.addTab({id:"tab-advanced",label:"Advanced"})}function x(e){var t;$.ajax({dataType:"json",method:"get",url:"uibuilder/uibvendorpackages",async:!1,success:function(e){d=e}}),void 0!==e.templateFolder&&""!==e.templateFolder||(e.templateFolder=r),t=e,$("#node-input-fwdInMessages").prop("checked",t.fwdInMessages),$("#node-input-allowScripts").prop("checked",t.allowScripts),$("#node-input-allowStyles").prop("checked",t.allowStyles),$("#node-input-copyIndex").prop("checked",t.copyIndex),$("#node-input-showfolder").prop("checked",t.showfolder),$("#node-input-useSecurity").prop("checked",t.useSecurity),$("#node-input-allowUnauth").prop("checked",t.allowUnauth),$("#node-input-tokenAutoExtend").prop("checked",t.tokenAutoExtend),$("#node-input-reload").prop("checked",t.reload),k(e),$(`#node-input-sourceFolder option[value="${e.sourceFolder||"src"}"]`).prop("selected",!0),$("#node-input-sourceFolder").val(e.sourceFolder||"src"),$("#node-input-showfolder").on("change",function(){!1===$(this).is(":checked")?$("#show-src-folder-idx-url").hide():$("#show-src-folder-idx-url").show()}),v(e),$("#show-security-props").css("cursor","pointer"),$("#show-security-props").on("click",function(){$("#sec-props").toggle(),$("#sec-props").is(":visible")?$("#show-security-props").html('<i class="fa fa-caret-down"></i> Security Settings'):$("#show-security-props").html('<i class="fa fa-caret-right"></i> Security Settings')}),0===$("#node-input-jwtSecret").val().length&&$("#node-input-jwtSecret").val(n),$("#node-input-useSecurity").is(":checked")&&0===$("#node-input-sessionLength").val().length&&$("#node-input-sessionLength").val(i),$("#node-input-useSecurity").on("change",function(){$(this).is(":checked")?($("#node-input-allowUnauth").prop("disabled",!1),$("#node-input-sessionLength").prop("disabled",!1),$("#node-input-jwtSecret").prop("disabled",!1),$("#node-input-tokenAutoExtend").prop("disabled",!1),0===$("#node-input-jwtSecret").val().length&&$("#node-input-jwtSecret").addClass("input-error"),0===$("#node-input-sessionLength").val().length&&$("#node-input-sessionLength").val(i),0===$("#node-input-jwtSecret").val().length&&$("#node-input-jwtSecret").val(n)):($("#node-input-allowUnauth").prop("disabled",!0),$("#node-input-sessionLength").prop("disabled",!0),$("#node-input-jwtSecret").prop("disabled",!0),$("#node-input-tokenAutoExtend").prop("disabled",!0))}),$("#nrMode").text(RED.settings.uibuilderNodeEnv),$("#node-input-url").on("change",y),void 0!==e.url&&""!==e.url||h(e.urlErrors,Object.keys(e.urlErrors).length<1),s(!0),$("#node-input-folder").change(function(){f()}),$("#node-input-filename").change(function(){p()}),$("#fldr-new-dialog_new").addClass("input-error").prop("disabled",!0),$("#fldr-input-newname").addClass("input-error").on("input",function(){0===$("#fldr-input-newname").val().length?($("#fldr-input-newname").addClass("input-error"),$("#fldr").addClass("input-error").prop("disabled",!0)):($("#fldr-input-newname").removeClass("input-error"),$("#fldr-new-dialog_new").removeClass("input-error").prop("disabled",!1))}),$("#fldr-new-dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Create",id:"fldr-new-dialog_new",click:function(){var e,t;e=$("#fldr-input-newname").val(),t=$("#node-input-url").val(),$.ajax({type:"POST",dataType:"json",url:"./uibuilder/admin/"+t,data:{folder:e,cmd:"newfolder"}}).done(function(){return RED.notify(`uibuilder: Folder <code>${e}</code> Created.`,{type:"success"}),f(),"Create folder succeeded"}).fail(function(e,t,o){return RED.notify("uibuilder: Create Folder Error.<br>"+o,{type:"error"}),"Create folder failed"}),$("#fldr-input-newname").val(null).addClass("input-error"),$("#fldr-new-dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}},{text:"Cancel",click:function(){$("#fldr-input-newname").val(null).addClass("input-error"),$("#fldr-new-dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}}]}).keyup(function(e){e.keyCode==$.ui.keyCode.ENTER&&$("#fldr_new_dialog_new").trigger("click")}),$("#btn-fldr-new").on("click",function(){$("#fldr_url").html($("#node-input-url").val()),$("#fldr-new-dialog").dialog("open")}),$("#fldr-del-dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Delete",id:"fldr-del-dialog_del",click:function(){var e,t;e=$("#node-input-url").val(),t=$("#node-input-folder").val(),$.ajax({type:"DELETE",dataType:"json",url:"./uibuilder/admin/"+e,data:{folder:t,cmd:"deletefolder"}}).done(function(){return RED.notify(`uibuilder: Folder <code>${t}</code> deleted.`,{type:"success"}),f(),"Delete folder succeeded"}).fail(function(e,t,o){return console.error("[uibuilder:deleteFolder:delete] Error "+t,o),RED.notify("uibuilder: Delete Folder Error.<br>"+o,{type:"error"}),"Delete folder failed"}),$(this).dialog("close")}},{text:"Cancel",click:function(){$(this).dialog("close")}}]}),$("#btn-fldr-del").on("click",function(){$("#fldr-del-dialog_del").addClass("input-error").css("color","brown"),$("#fldr-del-name").text($("#node-input-folder").val()),"src"===$("#node-input-folder").val()?$("#node-input-copyIndex").is(":checked")?$("#fldr-del-recopy").css("color","").text("Copy flag is set so the src folder will be recreated and the index.(html|js|css) files will be recopied from the master template."):$("#fldr-del-recopy").css("color","brown").text("Copy flag is NOT set so the src folder will NOT be recopied from the master template."):$("#fldr-del-recopy").css("color","").text(""),$("#fldr-del-dialog").dialog("open")}),$("#edit-reset").on("click",function(e){e.preventDefault(),p(),$("#file-action-message").text("")}),$("#edit-save").on("click",function(e){e.preventDefault();var t=RED.settings.get("auth-tokens");const o=new XMLHttpRequest;e="fname="+$("#node-input-filename").val()+"&folder="+$("#node-input-folder").val()+"&url="+$("#node-input-url").val()+"&reload="+$("#node-input-reload").val()+"&data="+encodeURIComponent(u.editorSession.getValue());o.open("POST","uibuilder/uibputfile",!0),o.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&(200===this.status?($("#file-action-message").text("File Saved"),s(!0)):$("#file-action-message").text("File Save FAILED"))},o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t&&o.setRequestHeader("Authorization","Bearer "+t.access_token),o.send(e)}),$("#edit_delete_dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Delete",id:"edit_del_dialog_del",click:function(){var e,t,o;e=$("#node-input-folder").val()||u.folder,t=$("#node-input-url").val(),o=$("#node-input-filename").val(),$.ajax({type:"DELETE",dataType:"json",url:"./uibuilder/admin/"+t,data:{folder:e,fname:o,cmd:"deletefile"}}).done(function(){return RED.notify(`uibuilder: File <code>${e}/${o}</code> Deleted.`,{type:"success"}),f(o),"Delete file succeeded"}).fail(function(e,t,o){return console.error("[uibuilder:deleteFile:delete] Error "+t,o),RED.notify("uibuilder: Delete File Error.<br>"+o,{type:"error"}),"Delete file failed"}),$(this).dialog("close")}},{text:"Cancel",click:function(){$(this).dialog("close")}}]}),$("#edit-delete").on("click",function(){$("#edit_del_dialog_del").addClass("input-error").css("color","brown"),$("#edit-delete-name").text($("#node-input-folder").val()+"/"+$("#node-input-filename").val()),"src"===$("#node-input-folder").val()?$("#node-input-copyIndex").is(":checked")?$("#edit-delete-recopy").css("color","").text("Copy flag is set so index.(html|js|css) files will be recopied from master template."):$("#edit-delete-recopy").css("color","brown").text("Copy flag is NOT set so index.(html|js|css) files will NOT be recopied from master template."):$("#edit-delete-recopy").css("color","").text(""),$("#edit_delete_dialog").dialog("open")}),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0),$("#edit-input-newname").addClass("input-error").on("input",function(){0===$("#edit-input-newname").val().length?($("#edit-input-newname").addClass("input-error"),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0)):($("#edit-input-newname").removeClass("input-error"),$("#edit_new_dialog_new").removeClass("input-error").prop("disabled",!1))}),$("#edit_new_dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Create",id:"edit_new_dialog_new",click:function(){var e,t,o;e=$("#edit-input-newname").val(),t=$("#node-input-folder").val()||u.folder,o=$("#node-input-url").val(),$.ajax({type:"POST",dataType:"json",url:"./uibuilder/admin/"+o,data:{folder:t,fname:e,cmd:"newfile"}}).done(function(){return RED.notify(`uibuilder: File <code>${t}/${e}</code> Created.`,{type:"success"}),f(e),"Create file succeeded"}).fail(function(e,t,o){return console.error("[uibuilder:createNewFile:post] Error "+t,o),RED.notify("uibuilder: Create File Error.<br>"+o,{type:"error"}),"Create file failed"}),$("#edit-input-newname").val(null).addClass("input-error"),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}},{text:"Cancel",click:function(){$("#edit-input-newname").val(null).addClass("input-error"),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}}]}).keyup(function(e){e.keyCode==$.ui.keyCode.ENTER&&$("#edit_new_dialog_new").click()}),$("#edit-new").on("click",function(){$("#file_url").html($("#node-input-url").val()),$("#file_fldr").html($("#node-input-folder").val()),$("#edit_new_dialog").dialog("open")}),$("#node-function-expand-js").on("click",function(e){e.preventDefault();var o=u.editor.getValue();RED.editor.editText({mode:$("#node-input-format").val(),value:o,width:"Infinity",cursor:u.editor.getCursorPosition(),complete:function(e,t){u.editor.setValue(e,-1),u.editor.gotoLine(t.row+1,t.column,!1),setTimeout(function(){u.editor.focus(),e!==o&&s(!1)},300)}})})}RED.events.on("nodes:add",function(e){"uibuilder"===e.type&&(l[e.id]=e.url)}),RED.events.on("nodes:change",function(e){"uibuilder"===e.type&&(o("nodes:change:",e),l[e.id]=e.url)}),RED.events.on("nodes:remove",function(e){"uibuilder"===e.type&&(o(">> nodes:remove >>",e),delete l[e.id])}),RED.nodes.registerType("uibuilder",{category:"uibuilder",color:"#E6E0F8",defaults:{name:{value:""},topic:{value:""},url:{required:!0,validate:function(e){$.ajax({type:"GET",async:!1,dataType:"json",url:"./uibuilder/admin/"+e,data:{cmd:"listinstances"},success:function(e){a=e}}),this.urlErrors={},this.isDeployed=void 0!==a[this.id],this.urlDeployedChanged=a[this.id]!==e,this.urlChanged=this.url!==e;let t=Object.values(a).indexOf(e);return this.urlDeployedDup=-1<t&&Object.keys(a)[t]!==this.id,t=Object.values(l).indexOf(e),this.urlEditorDup=-1<t&&Object.keys(l)[t]!==this.id,!1===this.isDeployed&&!0===this.urlEditorDup&&(o(">> Copy/Paste >>",this.id,this.url),this.urlErrors.config="Pasted or imported, URL must be changed"),void 0===e&&(this.urlErrors.config="Not yet configured, valid URL needed"),void 0===e||""===e?this.urlErrors.none="Must not be empty":(20<e.length&&(this.urlErrors.len="Too long, must be <= 20 chars"),-1!==e.indexOf("..")&&(this.urlErrors.dbldot="Cannot contain <code>..</code> (double-dot)"),-1!==e.indexOf("/")&&(this.urlErrors.fslash="Cannot contain <code>/</code>"),-1!==e.indexOf("\\")&&(this.urlErrors.bslash="Cannot contain <code>\\</code>"),-1!==e.indexOf(" ")&&(this.urlErrors.sp="Cannot contain spaces"),"_"===e.substring(0,1)&&(this.urlErrors.strtU="Cannot start with <code>_</code> (underscore)"),"."===e.substring(0,1)&&(this.urlErrors.strtDot="Cannot start with <code>.</code> (dot)"),"templates"===e.toLowerCase().substring(0,9)&&(this.urlErrors.templ='Cannot be "templates"')),!0===this.urlDeployedDup&&(this.urlErrors.dup="Cannot be a URL already deployed"),!0===this.urlEditorDup&&(this.urlErrors.dup="Cannot be a URL already in use"),void 0!==e&&""!==e&&(this.folderExists=function(e){if(void 0===e)return!1;let i=!1;return $.ajax({type:"GET",async:!1,dataType:"json",url:"./uibuilder/admin/"+e,data:{cmd:"checkfolder"},success:function(e){i=e},error:function(e,t,o){"Not Found"!==o&&console.error("[uibuilder:queryFolderExists] Error "+t,o),i=!1}}),i}(e),!0===this.folderExists&&!0===this.urlChanged&&(o(">> folder already exists >>",this.url,this.id),RED.notify(`<b>WARNING</b>: <p>The folder for the chosen URL (${e}) is already exists.<br>It will be adopted by this node.</p>`,{type:"warning"})),!1===this.folderExists&&(this.urlErrors.fldNotExist="URL does not yet exist. You must Deploy first.<br>If changing a deployed URL, the folder will be renamed on Deploy")),this.isDeployed&&!0===this.deployedUrlChanged&&(o(">> deployed url changed >>",this.url,this.oldUrl,this.id),this.urlErrors.warnChange=`Renaming from ${this.url} to ${e}. <b>MUST</b> redeploy now`,RED.notify(`<b>NOTE</b>: <p>You are renaming the url from ${this.url} to ${e}.<br>You <b>MUST</b> redeploy before doing anything else.</p>`,{type:"warning"})),0<Object.keys(this.urlErrors).length?(this.urlValid=!1,h(this.urlErrors,!1)):(this.urlValid=!0,h(this.urlErrors,!0)),!(1!==Object.keys(this.urlErrors).length||!this.urlErrors.fldNotExist)||this.urlValid}},fwdInMessages:{value:!1},allowScripts:{value:!1},allowStyles:{value:!1},copyIndex:{value:!0},templateFolder:{value:r},extTemplate:{value:""},showfolder:{value:!1},useSecurity:{value:!1},allowUnauth:{value:!1},allowAuthAnon:{value:!1},sessionLength:{value:i,validate:function(){var e=$("#node-input-sessionLength").val();return!(!0===$("#node-input-useSecurity").is(":checked")&&e.toString().length<1)}},tokenAutoExtend:{value:!1},oldUrl:{value:void 0},reload:{value:!1},sourceFolder:{value:"src",required:!0},deployedVersion:{validate:function(){return!(void 0!==this.url&&(void 0===this.deployedVersion?"0":this.deployedVersion)<RED.settings.uibuilderRedeployNeeded&&RED.settings.uibuilderCurrentVersion>RED.settings.uibuilderRedeployNeeded)||(RED.notify(`<i>uibuilder ${this.url}</i><br>uibuilder has been updated since you last deployed this instance. Please deploy now.`,{modal:!1,fixed:!1,type:"warning"}),!(this.mustChange=!0))}}},credentials:{jwtSecret:{type:"password"}},inputs:1,inputLabels:"Msg to send to front-end",outputs:2,outputLabels:["Data from front-end","Control Msgs from front-end"],icon:"ui_template.png",paletteLabel:"uibuilder",label:function(){var e=this.url?`<${this.url}>`:"<no url>";return(this.name?this.name+" ":"")+e},oneditprepare:function(){x(this)},oneditsave:function(){!0===u.editorLoaded&&(u.editor.destroy(),delete u.editor,u.editorLoaded=!1);let e;""!==$("#node-input-url").val()&&(e=$("#node-input-url").val()),e!==this.url?(this.oldUrl=this.url,o(`>> oneditsave URL CHANGED >> New=${$("#node-input-url").val()}, Old=`+this.url)):void 0!==this.oldUrl&&(this.oldUrl=void 0),(this.changed||this.mustChange)&&(this.deployedVersion=RED.settings.uibuilderCurrentVersion)},oneditcancel:function(){!0===u.editorLoaded&&(u.editor.destroy(),delete u.editor,u.editorLoaded=!1)},oneditresize:function(){b();try{$("#node-input-packageList").editableList("height",w())}catch(e){}},oneditdelete:function(){if(this.isDeployed){const t=this;let e=RED.notify(`<b>DELETE</b>: <p>You are deleting a uibuilder instance with url <i>${this.url}</i>.<br>Would you like to also delete the folder?<br><b>WARNING</b>: This cannot be undone.</p>`,{modal:!0,fixed:!0,type:"warning",buttons:[{text:"Yes",click:function(){$.ajax({type:"PUT",dataType:"json",url:"./uibuilder/admin/"+t.url,data:{cmd:"deleteondelete"}}).fail(function(e,t,o){console.error("[uibuilder:oneditdelete:PUT] Error "+t,o),RED.notify("uibuilder: Request url folder delete - error.<br>Folder will not be deleted, please delete manually.<br>"+o,{type:"error"})}),e.close(),RED.notify(`The folder <i>${t.url}</i> will be deleted when you redeploy.`,{type:"compact"})}},{text:"NO",class:"primary",click:function(){e.close()}}]})}}})}();