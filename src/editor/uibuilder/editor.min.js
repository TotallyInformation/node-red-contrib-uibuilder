!function(){"use strict";const e="127.0.0.1"===location.hostname,i=e?console.log:function(){};if(i("[uibuilder] DEBUG ON (because running on localhost)"),Object.entries||(Object.entries=function(e){for(var t=Object.keys(e),i=t.length,o=new Array(i);i--;)o[i]=[t[i],e[t[i]]];return o}),!Object.values){const x=Function.bind.call(Function.call,Array.prototype.reduce),D=Reflect.ownKeys,R=Function.bind.call(Function.call,Array.prototype.concat),C=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable);Object.values=function(i){return x(D(i),(e,t)=>R(e,"string"==typeof t&&C(i,t)?[i[t]]:[]),[])}}const r="blank",o={};var a=[],n=RED.settings.uibuilderInstances;const u={format:"html",folder:"src",fname:"index.html",fullscreen:!1};function t(o){if(""===o||"string"!=typeof o)return"No package";RED.notify("Starting removal of npm package "+o),$("i.spinner").show(),$.get("uibuilder/uibnpmmanage?cmd=remove&package="+o,function(e){!0===e.success?(console.log("[uibuilder:removePackageRow:get] PACKAGE REMOVED. ",o),RED.notify("Successfully uninstalled npm package "+o,"success"),a[o]&&delete a[o]):(console.log("[uibuilder:removePackageRow:get] ERROR ON PACKAGE REMOVAL ",e.result),RED.notify("FAILED to uninstall npm package "+o,"error"),$("#node-input-packageList").editableList("addItem",o)),$("i.spinner").hide()}).fail(function(e,t,i){return console.error("[uibuilder:removePackageRow:get] Error "+t,i),RED.notify("FAILED to uninstall npm package "+o,"error"),$("#node-input-packageList").editableList("addItem",o),$("i.spinner").hide(),"removePackageRow failed"})}function c(e){let t="text",i=e.split(".");if(""===i[0]&&i.shift(),1<i.length){var o=i.pop().toLowerCase().trim();switch(o){case"js":t="javascript";break;case"html":case"css":case"json":t=o;break;case"vue":t="html";break;case"md":t="markdown";break;case"yaml":case"yml":t="yaml";break;default:t=o}}return t}function l(e){$("#edit-save").prop("disabled",e),$("#edit-reset").prop("disabled",e),$("#edit-close").prop("disabled",!e),$("#node-edit-file").prop("disabled",!e),$("#node-input-filename").prop("disabled",!e),$("#node-dialog-ok").prop("disabled",!e),$("#node-dialog-cancel").prop("disabled",!e),e?($("#node-dialog-ok").css("cursor","pointer"),$("#node-dialog-cancel").css("cursor","pointer")):($("#file-action-message").text("Save Required"),$("#node-dialog-ok").css("cursor","not-allowed"),$("#node-dialog-cancel").css("cursor","not-allowed"))}function p(){var e=$("#node-input-url").val(),t=$("#node-input-folder").val(),i=(null===t&&(t=localStorage.getItem("uibuilder."+e+".folder")||u.folder),$("#node-input-filename").val()),o=(null===i&&(i=localStorage.getItem("uibuilder."+e+".selectedFile")||u.fname),u.folder=t,u.fname=i,localStorage.setItem("uibuilder."+e+".folder",u.folder),localStorage.setItem("uibuilder."+e+".selectedFile",u.fname),u.format=c(i));$("#node-input-format").val(o),$.get("uibuilder/uibgetfile?url="+e+"&fname="+i+"&folder="+t,function(e){$("#node-input-template-editor").show(),$("#node-input-template-editor-no-file").hide(),u.editorSession.setValue(e),u.editorSession.setMode({path:"ace/mode/"+o,v:Date.now()}),u.editorSession.getUndoManager().isClean(),u.editor.focus()}).fail(function(e,t,i){console.error("[uibuilder:getFileContents:get] Error "+t,i),u.editorSession.setValue(""),$("#node-input-template-editor").hide(),$("#node-input-template-editor-no-file").show()}).always(function(){l(!0),$("#node-input-format option:selected").length||$("#node-input-format").val("text")})}function d(d){var a=$("#node-input-url").val(),s=$("#node-input-folder").val(),e=$("#node-input-filename").val();null===(d=void 0===d?e:d)&&(d=localStorage.getItem("uibuilder."+a+".selectedFile")||void 0),null===s&&(s=localStorage.getItem("uibuilder."+a+".folder")||void 0),$("#node-input-filename option").remove(),$("#node-input-folder option").remove(),$.ajax({type:"GET",dataType:"json",url:"./uibuilder/admin/"+a,data:{cmd:"listall"}}).done(function(e,t,i){let o="",r=!1,n=!1;var l=Object.keys(e).sort(),l=($.each(l,function(e,t){""===t&&(t="root"),$("#node-input-folder").append($("<option>",{value:t,text:t}))}),e[s]||(s=e.src?"src":"root"),$("#node-input-folder").val(s),u.folder=s,localStorage.setItem("uibuilder."+a+".folder",s),e[s]);$.each(l,function(e,t){$("#node-input-filename").append($("<option>",{value:t,text:t})),0===e&&(o=t),t===u.fname&&(r=!0),t===d&&(n=!0)}),!0===n?u.fname=d:!0===r?u.fname="index.html":u.fname=o,$("#node-input-filename").val(u.fname),u.format=c(u.fname),localStorage.setItem("uibuilder."+a+".selectedFile",u.fname)}).fail(function(e,t,i){console.error("[uibuilder:getFileList:getJSON] Error "+t,i),u.fname="",u.format="text",RED.notify("uibuilder: Folder and file listing error.<br>"+i,{type:"error"})}).always(function(){p()})}function s(){let e;if(!0===u.editorLoaded){if(document.fullscreenElement)$("#edit-props").css("background-color","#f6f6f6").css("padding","1em"),e=parseInt($("#edit-props").css("height"),10),e-=25,$("#node-function-expand-js").css("background-color","black").html('<i class="fa fa-compress"></i>'),u.fullscreen=!0;else{if("auto"===$("#edit-outer").css("top"))return;$("#edit-props").css("background-color","").css("padding",""),e=$(".red-ui-tray-footer").position().top-$("#edit-outer").offset().top-35,$("#node-function-expand-js").css("background-color","").html('<i class="fa fa-expand"></i>'),u.fullscreen=!1}for(var t=$("#edit-props > div:not(.node-text-editor-row)"),i=0;i<t.length;i++)e-=$(t[i]).outerHeight(!0);$("#node-input-template-editor").css("height",e+"px"),u.editor.resize()}}function f(){var e=RED.settings.get("auth-tokens");const t=new XMLHttpRequest;var i="fname="+$("#node-input-filename").val()+"&folder="+$("#node-input-folder").val()+"&url="+$("#node-input-url").val()+"&reload="+$("#node-input-reload").prop("checked")+"&data="+encodeURIComponent(u.editorSession.getValue());t.open("POST","uibuilder/uibputfile",!0),t.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&(200===this.status?($("#file-action-message").text("File Saved"),l(!0)):$("#file-action-message").text("File Save FAILED"))},t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e&&t.setRequestHeader("Authorization","Bearer "+e.access_token),t.send(i)}function b(e){$.ajax({type:"GET",async:!1,dataType:"json",url:"./uibuilder/admin/_",data:{cmd:"listinstances"},success:function(e){n=e}}),e&&(e.isDeployed=void 0!==n[e.id])}function m(e,t=!0){!0===t?($("#node-input-templateFolder, #btn-load-template").prop("disabled",!1).css({cursor:"pointer"}),$("#red-ui-tab-tab-files, #red-ui-tab-tab-libraries, #red-ui-tab-tab-security, #red-ui-tab-tab-advanced, info").css({cursor:"pointer"}),$("#red-ui-tab-tab-files>a, #red-ui-tab-tab-libraries>a, #red-ui-tab-tab-security>a, #red-ui-tab-tab-advanced>a, info>a").prop("disabled",!1).css({"pointer-events":"auto",cursor:"pointer",opacity:1}),$("#uibuilderurl, #uibinstanceconf").prop("disabled",!1).css({cursor:"pointer",opacity:1}),$("#url-errors").remove()):($("#node-input-templateFolder, #btn-load-template").prop("disabled",!0).css({cursor:"not-allowed"}),$("#red-ui-tab-tab-files, #red-ui-tab-tab-libraries, #red-ui-tab-tab-security, #red-ui-tab-tab-advanced, info").css({cursor:"not-allowed"}),$("#red-ui-tab-tab-files>a, #red-ui-tab-tab-libraries>a, #red-ui-tab-tab-security>a, #red-ui-tab-tab-advanced>a, info>a").prop("disabled",!0).css({"pointer-events":"none",cursor:"not-allowed",opacity:.3}),$("#uibuilderurl, #uibinstanceconf").prop("disabled",!0).css({cursor:"not-allowed",opacity:.3}),$("#url-errors").remove(),$("#url-input").after(`
                <div id="url-errors" class="form-row" style="color:var(--red-ui-text-color-error)">
                    ${Object.values(e).join("<br>")} 
                </div>
            `))}function h(){var e,t=$("#node-input-templateFolder").val();if(RED.settings.uibuilderTemplates[t]){const i=RED.settings.uibuilderTemplates[t].dependencies||[],o=[];i.forEach(e=>{a[e]||o.push(e)}),0<o.length&&(e=RED.notify(`WARNING<br /><br />The selected uibuilder template (${t}) is MISSING the following dependencies:<div> ${o.join(", ")}</div><br />Please install them using the uibuilder Library Manager or select a different template.`,{type:"warning",modal:!0,fixed:!0,buttons:[{text:"OK",class:"primary",click:function(){e.close()}}]}))}else console.error("[uibuilder:checkDependencies] Template name not found: "+t)}function g(){var o=RED.notify(`WARNING<br /><br />
            Are you <b>SURE</b> you want to overwrite your code
            with the template <b><code>${$("#node-input-templateFolder").val()}</code></b>?<br /><br />
            <b>THIS CANNOT BE UNDONE.</b>`,{type:"warning",modal:!0,fixed:!0,buttons:[{text:"Cancel, don't overwrite",class:"primary",click:function(){o.close()}},{text:"OK, overwrite",click:function(){var e,t,i;e=$("#node-input-templateFolder").val(),t=$("#node-input-extTemplate").val(),i=$("#node-input-url").val(),$.ajax({type:"POST",dataType:"json",url:"./uibuilder/admin/"+i,data:{template:e,extTemplate:t,cmd:"replaceTemplate"}}).done(function(e,t,i){return RED.notify(`<b>uibuilder</b>:<br><br>${i.statusText}<br>`,{type:"success"}),"Template load succeeded"}).fail(function(e,t,i){return console.error("[uibuilder:loadTemplate] Error "+t,i),RED.notify(`<b>uibuilder</b>:<br><br>Template Load Error.<br><br>${i}<br>`,{type:"error"}),"Template load failed"}),o.close()}}]})}function y(i){$("#adv-templ").hide(),$("#show-templ-props").css("cursor","pointer"),$("#show-templ-props").on("click",function(){$("#adv-templ").toggle(),$("#adv-templ").is(":visible")?$("#show-templ-props").html('<i class="fa fa-caret-down"></i> Template Settings'):$("#show-templ-props").html('<i class="fa fa-caret-right"></i> Template Settings')});{var o=i;let e=o.templateFolder,t=[];RED.settings&&RED.settings.uibuilderTemplates?t=RED.settings.uibuilderTemplates:console.error("[uibuilder:populateTemplateDropdown] Cannot access RED.settings for node "+o.id),Object.values(t).forEach(e=>{$("#node-input-templateFolder").append($("<option>",{value:e.folder,text:e.name}))}),t[e]||(e=r),$(`#node-input-templateFolder option[value="${e}"]`).prop("selected",!0),$("#node-input-templateFolder").val(e),$("#node-templSel-info").text(t[e].description),e}h(),"external"===$("#node-input-templateFolder").val()&&$("#et-input").show(),$("#node-input-templateFolder").on("change",function(){RED.settings.uibuilderTemplates[i.templateFolder]&&$("#node-templSel-info").text(RED.settings.uibuilderTemplates[i.templateFolder].description),h(),"external"===$("#node-input-templateFolder").val()?$("#et-input").show():$("#et-input").hide()}),$("#btn-load-template").on("click",function(e){e.preventDefault(),g()})}function v(){return $(".red-ui-tray-footer").position().top-$("#package-list-container").offset().top+25}function w(d){$("#node-input-packageList").editableList({addItem:function(i,o,r){{var n=d,l=o;o=r;let e="",t;return e=0===Object.entries(o).length?`
                <div>
                    <label for="packageList-input-${l}" style="width:3em;">Name:</label>
                    <input type="text" id="packageList-input-${l}" title="" style="width:80%" placeholder="Valid npm package name">
                </div>
                <div>
                    <label for="packageList-tag-${l}" style="width:3em;">Tag:</label>
                    <input type="text" id="packageList-tag-${l}" title="" style="width:80%" placeholder="npm: @tag/version, GH: #branch/tag">
                </div>
                <div>
                    <label for="packageList-button-${l}" style="width:3em;"></label>
                    <button id="packageList-button-${l}" style="width:5em;">Install</button>
                </div>
            `:(t=a[o],`
                <div id="packageList-row-${l}" class="packageList-row-data">
                    <a href="${t.homepage}" target="_blank" title="Click to open homepage in a new tab"><b>${o}</b></a>, <span title="${t.spec}">${t.installedVersion}</span>
                    <br>
                    URL to use: <code style="white-space:inherit;" title="NB: The actual resource is an estimate, check the package docs for the actual entry point">
                        ${t.url}
                    </code>
                </div>
            `),$(e).appendTo(i),0===Object.entries(o).length&&($("#packageList-input-"+l).tooltip({content:'Enter one of:<ul><li>An npm package name (optionally with leading)</li><li>A GitHub user/repo</li><li>A filing system path to a local package</li></ul>Ensure that you select the correct "From" dropdown.'}),$("#packageList-ver-"+l).tooltip({content:"Optional. Branch, Tag or Version to install (defaults to @latest)"})),void $("#packageList-button-"+l).on("click",function(){$("i.spinner").show();var o=String($("#packageList-input-"+l).val()),e=String($("#packageList-tag-"+l).val());0!==o.length&&(RED.notify("Installing npm package "+o),$.get(`uibuilder/uibnpmmanage?cmd=install&package=${o}&url=${n.url}&tag=`+e,function(e){var t=e.result[0];!0===e.success?(a=e.result[1],console.log("[uibuilder:addPackageRow:get] PACKAGE INSTALLED. ",o,n.url,"\n\n",t,"\n "),RED.notify(`Successful installation of npm package ${o} for `+n.url,"success"),$("#node-input-packageList").editableList("empty"),$("#node-input-packageList").editableList("addItems",Object.keys(a))):(console.log("[uibuilder:addPackageRow:get] ERROR ON INSTALLATION OF PACKAGE ",o,n.url,"\n\n",t,"\n "),RED.notify(`FAILED installation of npm package ${o} for `+n.url,"error")),$("i.spinner").hide()}).fail(function(e,t,i){return console.error("[uibuilder:addPackageRow:get] Error "+t,i),RED.notify(`FAILED installation of npm package ${o} for `+n.url,"error"),$("i.spinner").hide(),"addPackageRow failed"}))})}},removeItem:t,header:$("<div>").append("<b>Installed Packages (Install again to update)</b>"),height:v(),addButton:!0,removable:!0,scrollOnAdd:!0,sortable:!1}),$("#node-input-packageList").editableList("empty"),$("#node-input-packageList").editableList("addItems",Object.keys(a)),$(".red-ui-editableList-addButton").after(' <i class="spinner"></i>'),$("i.spinner").hide()}function E(o){const e=RED.tabs.create({id:"tabs",scrollable:!1,collapsible:!1,onchange:function(e){switch($("#tabs-content").children().hide(),$("#"+e.id).show(),e.id){case"tab-files":var t=o;if(d(),!0!==u.editorLoaded){""!==$("#node-input-template").val("")&&$("#node-input-template").val(""),u.editor=RED.editor.createEditor({id:"node-input-template-editor",mode:"ace/mode/"+u.format,value:t.template}),u.editorSession=u.editor.getSession(),u.editor.on("input",function(){l(u.editorSession.getUndoManager().isClean())}),u.editorLoaded=!0;const i=document.getElementsByClassName("red-ui-editor-text-container");i.item(0).addEventListener("keydown",e=>{!0===e.ctrlKey&&"s"===e.key&&(e.preventDefault(),f())}),s(),p(),l(!0)}break;case"tab-libraries":w(o)}}});e.addTab({id:"tab-core",label:"Core"}),e.addTab({id:"tab-files",label:"Files"}),e.addTab({id:"tab-libraries",label:"Libraries"}),e.addTab({id:"tab-advanced",label:"Advanced"})}function k(t){$.ajax({dataType:"json",method:"get",url:"uibuilder/uibvendorpackages",async:!1,success:function(e){a=e}}),void 0!==t.templateFolder&&""!==t.templateFolder||(t.templateFolder=r),i=t,$("#node-input-fwdInMessages").prop("checked",i.fwdInMessages),$("#node-input-allowScripts").prop("checked",i.allowScripts),$("#node-input-allowStyles").prop("checked",i.allowStyles),$("#node-input-copyIndex").prop("checked",i.copyIndex),$("#node-input-showfolder").prop("checked",i.showfolder),$("#node-input-useSecurity").prop("checked",i.useSecurity),$("#node-input-allowUnauth").prop("checked",i.allowUnauth),$("#node-input-tokenAutoExtend").prop("checked",i.tokenAutoExtend),$("#node-input-reload").prop("checked",i.reload),E(t),$(`#node-input-sourceFolder option[value="${t.sourceFolder||"src"}"]`).prop("selected",!0),$("#node-input-sourceFolder").val(t.sourceFolder||"src"),$("#node-input-showfolder").on("change",function(){!1===$(this).is(":checked")?$("#show-src-folder-idx-url").hide():$("#show-src-folder-idx-url").show()}),y(t);{var i=t;let e;const o=window.origin.split(":");i.nodeRoot=RED.settings.httpNodeRoot.replace(/^\//,""),$("#info-webserver").empty(),e=!0===RED.settings.uibuilderCustomServer.isCustom?(o[0]=RED.settings.uibuilderCustomServer.type.replace("http2","https"),o[2]=RED.settings.uibuilderCustomServer.port,i.nodeRoot="","a custom"):"Node-RED's",i.urlPrefix=o.join(":")+"/"+i.nodeRoot,$("#info-webserver").append(`<div class="form-tips node-help">uibuilder is using ${e} webserver at ${i.urlPrefix} </div>`)}$("#node-input-url").on("change",function(){!function(e){var t=$(this).val();$("#uibuilderurl").prop("href",""+e.urlPrefix+t).text("Open "+e.nodeRoot+t),$("#uibinstanceconf").prop("href",`./uibuilder/instance/${t}?cmd=showinstancesettings`),$("#show-src-folder-idx-url").empty().append(`<div>at 
                    <a href="${e.urlPrefix}${t}/idx" target="_blank" 
                            style="color:var(--red-ui-text-color-link);text-decoration:underline;">
                        ${e.nodeRoot}${t}/idx
                    </a>
                </div>`)}.call(this,t)}),void 0!==t.url&&""!==t.url||m(t.urlErrors,Object.keys(t.urlErrors).length<1),l(!0),$("#node-input-folder").change(function(){d()}),$("#node-input-filename").change(function(){p()}),$("#fldr-new-dialog_new").addClass("input-error").prop("disabled",!0),$("#fldr-input-newname").addClass("input-error").on("input",function(){0===$("#fldr-input-newname").val().length?($("#fldr-input-newname").addClass("input-error"),$("#fldr").addClass("input-error").prop("disabled",!0)):($("#fldr-input-newname").removeClass("input-error"),$("#fldr-new-dialog_new").removeClass("input-error").prop("disabled",!1))}),$("#fldr-new-dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Create",id:"fldr-new-dialog_new",click:function(){var e,t;e=$("#fldr-input-newname").val(),t=$("#node-input-url").val(),$.ajax({type:"POST",dataType:"json",url:"./uibuilder/admin/"+t,data:{folder:e,cmd:"newfolder"}}).done(function(){return RED.notify(`uibuilder: Folder <code>${e}</code> Created.`,{type:"success"}),d(),"Create folder succeeded"}).fail(function(e,t,i){return RED.notify("uibuilder: Create Folder Error.<br>"+i,{type:"error"}),"Create folder failed"}),$("#fldr-input-newname").val(null).addClass("input-error"),$("#fldr-new-dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}},{text:"Cancel",click:function(){$("#fldr-input-newname").val(null).addClass("input-error"),$("#fldr-new-dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}}]}).keyup(function(e){e.keyCode==$.ui.keyCode.ENTER&&$("#fldr_new_dialog_new").trigger("click")}),$("#btn-fldr-new").on("click",function(){$("#fldr_url").html($("#node-input-url").val()),$("#fldr-new-dialog").dialog("open")}),$("#fldr-del-dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Delete",id:"fldr-del-dialog_del",click:function(){var e,t;e=$("#node-input-url").val(),t=$("#node-input-folder").val(),$.ajax({type:"DELETE",dataType:"json",url:"./uibuilder/admin/"+e,data:{folder:t,cmd:"deletefolder"}}).done(function(){return RED.notify(`uibuilder: Folder <code>${t}</code> deleted.`,{type:"success"}),d(),"Delete folder succeeded"}).fail(function(e,t,i){return console.error("[uibuilder:deleteFolder:delete] Error "+t,i),RED.notify("uibuilder: Delete Folder Error.<br>"+i,{type:"error"}),"Delete folder failed"}),$(this).dialog("close")}},{text:"Cancel",click:function(){$(this).dialog("close")}}]}),$("#btn-fldr-del").on("click",function(){$("#fldr-del-dialog_del").addClass("input-error").css("color","brown"),$("#fldr-del-name").text($("#node-input-folder").val()),"src"===$("#node-input-folder").val()?$("#node-input-copyIndex").is(":checked")?$("#fldr-del-recopy").css("color","").text("Copy flag is set so the src folder will be recreated and the index.(html|js|css) files will be recopied from the master template."):$("#fldr-del-recopy").css("color","brown").text("Copy flag is NOT set so the src folder will NOT be recopied from the master template."):$("#fldr-del-recopy").css("color","").text(""),$("#fldr-del-dialog").dialog("open")}),$("#edit-reset").on("click",function(e){e.preventDefault(),p(),$("#file-action-message").text("")}),$("#edit-save").on("click",function(e){e.preventDefault(),f()}),$("#edit_delete_dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Delete",id:"edit_del_dialog_del",click:function(){var e,t,i;e=$("#node-input-folder").val()||u.folder,t=$("#node-input-url").val(),i=$("#node-input-filename").val(),$.ajax({type:"DELETE",dataType:"json",url:"./uibuilder/admin/"+t,data:{folder:e,fname:i,cmd:"deletefile"}}).done(function(){return RED.notify(`uibuilder: File <code>${e}/${i}</code> Deleted.`,{type:"success"}),d(i),"Delete file succeeded"}).fail(function(e,t,i){return console.error("[uibuilder:deleteFile:delete] Error "+t,i),RED.notify("uibuilder: Delete File Error.<br>"+i,{type:"error"}),"Delete file failed"}),$(this).dialog("close")}},{text:"Cancel",click:function(){$(this).dialog("close")}}]}),$("#edit-delete").on("click",function(){$("#edit_del_dialog_del").addClass("input-error").css("color","brown"),$("#edit-delete-name").text($("#node-input-folder").val()+"/"+$("#node-input-filename").val()),"src"===$("#node-input-folder").val()?$("#node-input-copyIndex").is(":checked")?$("#edit-delete-recopy").css("color","").text("Copy flag is set so index.(html|js|css) files will be recopied from master template."):$("#edit-delete-recopy").css("color","brown").text("Copy flag is NOT set so index.(html|js|css) files will NOT be recopied from master template."):$("#edit-delete-recopy").css("color","").text(""),$("#edit_delete_dialog").dialog("open")}),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0),$("#edit-input-newname").addClass("input-error").on("input",function(){0===$("#edit-input-newname").val().length?($("#edit-input-newname").addClass("input-error"),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0)):($("#edit-input-newname").removeClass("input-error"),$("#edit_new_dialog_new").removeClass("input-error").prop("disabled",!1))}),$("#edit_new_dialog").dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,buttons:[{text:"Create",id:"edit_new_dialog_new",click:function(){var e,t,i;e=$("#edit-input-newname").val(),t=$("#node-input-folder").val()||u.folder,i=$("#node-input-url").val(),$.ajax({type:"POST",dataType:"json",url:"./uibuilder/admin/"+i,data:{folder:t,fname:e,cmd:"newfile"}}).done(function(){return RED.notify(`uibuilder: File <code>${t}/${e}</code> Created.`,{type:"success"}),d(e),"Create file succeeded"}).fail(function(e,t,i){return console.error("[uibuilder:createNewFile:post] Error "+t,i),RED.notify("uibuilder: Create File Error.<br>"+i,{type:"error"}),"Create file failed"}),$("#edit-input-newname").val(null).addClass("input-error"),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}},{text:"Cancel",click:function(){$("#edit-input-newname").val(null).addClass("input-error"),$("#edit_new_dialog_new").addClass("input-error").prop("disabled",!0),$(this).dialog("close")}}]}).keyup(function(e){e.keyCode==$.ui.keyCode.ENTER&&$("#edit_new_dialog_new").click()}),$("#edit-new").on("click",function(){$("#file_url").html($("#node-input-url").val()),$("#file_fldr").html($("#node-input-folder").val()),$("#edit_new_dialog").dialog("open")}),$("#node-function-expand-js").on("click",function(e){e.preventDefault();var i=u.editor.getValue();RED.editor.editText({mode:$("#node-input-format").val(),value:i,width:"Infinity",cursor:u.editor.getCursorPosition(),complete:function(e,t){u.editor.setValue(e,-1),u.editor.gotoLine(t.row+1,t.column,!1),setTimeout(function(){u.editor.focus(),e!==i&&l(!1)},300)}})})}RED.events.on("nodes:add",function(e){"uibuilder"===e.type&&(o[e.id]=e.url)}),RED.events.on("nodes:change",function(e){"uibuilder"===e.type&&(i("nodes:change:",e),o[e.id]=e.url)}),RED.events.on("nodes:remove",function(e){"uibuilder"===e.type&&(i(">> nodes:remove >>",e),delete o[e.id])}),RED.nodes.registerType("uibuilder",{category:"uibuilder",color:"#E6E0F8",defaults:{name:{value:""},topic:{value:""},url:{required:!0,validate:function(e){b(this),this.urlErrors={},this.urlDeployedChanged=n[this.id]!==e,this.urlChanged=this.url!==e;let t=Object.values(n).indexOf(e);return this.urlDeployedDup=-1<t&&Object.keys(n)[t]!==this.id,t=Object.values(o).indexOf(e),this.urlEditorDup=-1<t&&Object.keys(o)[t]!==this.id,!1===this.isDeployed&&!0===this.urlEditorDup&&(this.urlErrors.config="Pasted or imported, URL must be changed",e="",this.url=this.oldUrl=void 0,$("#node-input-url").val(""),i("[uib] >> Copy/Paste >>",this.id,"this.url:",this.url,", value:",e,", this.oldUrl:",this.oldUrl)),void 0===e&&(this.urlErrors.config="Not yet configured, valid URL needed"),void 0===e||""===e?this.urlErrors.none="Must not be empty":(20<e.length&&(this.urlErrors.len="Too long, must be <= 20 chars"),-1!==e.indexOf("..")&&(this.urlErrors.dbldot="Cannot contain <code>..</code> (double-dot)"),-1!==e.indexOf("/")&&(this.urlErrors.fslash="Cannot contain <code>/</code>"),-1!==e.indexOf("\\")&&(this.urlErrors.bslash="Cannot contain <code>\\</code>"),-1!==e.indexOf(" ")&&(this.urlErrors.sp="Cannot contain spaces"),"_"===e.substring(0,1)&&(this.urlErrors.strtU="Cannot start with <code>_</code> (underscore)"),"."===e.substring(0,1)&&(this.urlErrors.strtDot="Cannot start with <code>.</code> (dot)"),"templates"===e.toLowerCase().substring(0,9)&&(this.urlErrors.templ='Cannot be "templates"'),"uibuilder"===e.toLowerCase()&&(this.urlErrors.uibname='Cannot be "uibuilder" (since v5)')),!0===this.urlDeployedDup&&(this.urlErrors.dup="Cannot be a URL already deployed"),!0===this.urlEditorDup&&(this.urlErrors.dup="Cannot be a URL already in use"),void 0!==e&&""!==e&&(this.folderExists=function(e){if(void 0===e)return!1;let o=!1;return $.ajax({type:"GET",async:!1,dataType:"json",url:"./uibuilder/admin/"+e,data:{cmd:"checkfolder"},success:function(e){o=e},error:function(e,t,i){"Not Found"!==i&&console.error("[uibuilder:queryFolderExists] Error "+t,i),o=!1}}),o}(e),!0===this.folderExists&&!0===this.urlChanged&&(i(">> folder already exists >>",this.url,this.id),RED.notify(`<b>WARNING</b>: <p>The folder for the chosen URL (${e}) is already exists.<br>It will be adopted by this node.</p>`,{type:"warning"})),!1===this.folderExists&&(this.urlErrors.fldNotExist="URL does not yet exist. You must Deploy first.<br>If changing a deployed URL, the folder will be renamed on Deploy")),this.isDeployed&&!0===this.deployedUrlChanged&&(i("[uib] >> deployed url changed >> this.url:",this.url,", this.oldUrl:",this.oldUrl,this.id),this.urlErrors.warnChange=`Renaming from ${this.url} to ${e}. <b>MUST</b> redeploy now`,RED.notify(`<b>NOTE</b>: <p>You are renaming the url from ${this.url} to ${e}.<br>You <b>MUST</b> redeploy before doing anything else.</p>`,{type:"warning"})),0<Object.keys(this.urlErrors).length?(this.urlValid=!1,m(this.urlErrors,!1)):(this.urlValid=!0,m(this.urlErrors,!0)),!(1!==Object.keys(this.urlErrors).length||!this.urlErrors.fldNotExist)||this.urlValid}},fwdInMessages:{value:!1},allowScripts:{value:!1},allowStyles:{value:!1},copyIndex:{value:!0},templateFolder:{value:r},extTemplate:{value:""},showfolder:{value:!1},oldUrl:{value:void 0},reload:{value:!1},sourceFolder:{value:"src",required:!0},deployedVersion:{validate:function(){return!(void 0!==this.url&&(void 0===this.deployedVersion?"0":this.deployedVersion)<RED.settings.uibuilderRedeployNeeded&&RED.settings.uibuilderCurrentVersion>RED.settings.uibuilderRedeployNeeded)||(RED.notify(`<i>uibuilder ${this.url}</i><br>uibuilder has been updated since you last deployed this instance. Please deploy now.`,{modal:!1,fixed:!1,type:"warning"}),!(this.mustChange=!0))}}},credentials:{jwtSecret:{type:"password"}},inputs:1,inputLabels:"Msg to send to front-end",outputs:2,outputLabels:["Data from front-end","Control Msgs from front-end"],icon:"ui_template.png",paletteLabel:"uibuilder",label:function(){var e=this.url?`<${this.url}>`:"<no url>";return(this.name?this.name+" ":"")+e},oneditprepare:function(){k(this)},oneditsave:function(){i("[uib] >> this >>",this),!0===u.editorLoaded&&(u.editor.destroy(),delete u.editor,u.editorLoaded=!1);let e;(e=""!==$("#node-input-url").val()?$("#node-input-url").val():e)!==this.url?(this.oldUrl=this.url,i(`>> oneditsave URL CHANGED >> New=${$("#node-input-url").val()}, Old=`+this.url)):void 0!==this.oldUrl&&(this.oldUrl=void 0),(this.changed||this.mustChange)&&(this.deployedVersion=RED.settings.uibuilderCurrentVersion)},oneditcancel:function(){!0===u.editorLoaded&&(u.editor.destroy(),delete u.editor,u.editorLoaded=!1)},oneditresize:function(){s();try{$("#node-input-packageList").editableList("height",v())}catch(e){}},oneditdelete:function(){if(b(this),i("[uib] >> deleting >> isDeployed? ",this.isDeployed,void 0!==n[this.id]),this.isDeployed){const t=this;let e=RED.notify(`<b>DELETE</b>: <p>You are deleting a uibuilder instance with url <i>${this.url}</i>.<br>Would you like to also delete the folder?<br><b>WARNING</b>: This cannot be undone.</p>`,{modal:!0,fixed:!0,type:"warning",buttons:[{text:"Yes",click:function(){$.ajax({type:"PUT",dataType:"json",url:"./uibuilder/admin/"+t.url,data:{cmd:"deleteondelete"}}).fail(function(e,t,i){console.error("[uibuilder:oneditdelete:PUT] Error "+t,i),RED.notify("uibuilder: Request url folder delete - error.<br>Folder will not be deleted, please delete manually.<br>"+i,{type:"error"})}),e.close(),RED.notify(`The folder <i>${t.url}</i> will be deleted when you redeploy.`,{type:"compact"})}},{text:"NO",class:"primary",click:function(){e.close()}}]})}}})}();