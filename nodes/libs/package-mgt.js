"use strict";const r=require("path"),l=require("fs-extra"),u=require("execa");class d{#e=!1;#t=new Error("pkgMgt: this.log is undefined");#i=new Error("pkgMgt: this.uib is undefined");#s=new Error("pkgMgt: this.uib.rootFolder is null");mergedPkgMasterList=[];packageJson="package.json";uibPackageJson;globalPrefix;constructor(){this.globalPrefix=this.npmGetGlobalPrefix()}npmGetGlobalPrefix(){const e={all:!0},n=["config","get","prefix"];let s;try{s=u.sync("npm",n,e).stdout}catch(t){console.error(">>>>>",t.all),s=t.all}return s}setup(e){if(!e)throw new Error("[uibuilder:UibPackages.js:setup] Called without required uib parameter or uib is undefined.");if(e.RED===null)throw new Error("[uibuilder:UibPackages.js:setup] uib.RED is null");if(this.#e===!0){e.RED.log.warn("[uibuilder:UibPackages:setup] Setup has already been called, it cannot be called again.");return}this.RED=e.RED,this.uib=e;const n=this.log=e.RED.log;n.trace("[uibuilder:package-mgt:setup] Package Management setup started");const s=this.uibPackageJson=this.getUibRootPJ();s.version=this.uib.version,s.dependencies||(s.dependencies={}),s.uibuilder||(s.uibuilder={}),s.uibuilder.packages||(s.uibuilder.packages={}),this.pkgsQuickUpd(),this.#e=!0,this.updateInstalledPackageDetails(),n.trace("[uibuilder:package-mgt:setup] Package Management setup completed")}pkgsQuickUpd(){if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw this.#s;const e=this.uibPackageJson;for(const n in e.uibuilder.packages)e.dependencies[n]||delete e.uibuilder.packages[n];for(const n in e.dependencies)e.uibuilder.packages[n]||(e.uibuilder.packages[n]={installedVersion:e.dependencies[n]});for(const n in e.uibuilder.packages){const s=e.uibuilder.packages[n];if(this.uib.rootFolder===null)throw this.#s;s.installFolder=r.join(this.uib.rootFolder,"node_modules",n),s.packageUrl="/"+n}this.writePackageJson(this.uib.rootFolder,e)}readPackageJson(e){if(this.log===void 0)throw this.#t;let n=null;try{//! TODO: Replace fs-extra
n=l.readJsonSync(r.join(e,this.packageJson),"utf8"),this.log.trace(`[uibuilder:package-mgt:readPackageJson] package.json file read successfully from ${e}`)}catch(s){this.log.error(`[uibuilder:package-mgt:readPackageJson] Failed to read package.json file from  ${e}`,this.packageJson,s)}return n}async writePackageJson(e,n){const s=r.join(e,this.packageJson);try{await l.copy(s,`${s}.bak`),this.log.trace(`[uibuilder:package-mgt:writePackageJson] package.json file successfully backed up in ${e}`)}catch(t){this.log.error(`[uibuilder:package-mgt:writePackageJson] Failed to copy package.json to backup.  ${e}`,this.packageJson,t)}try{await l.writeJson(s,n,{spaces:2}),this.log.trace(`[uibuilder:package-mgt:writePackageJson] package.json file written successfully in ${e}`)}catch(t){this.log.error(`[uibuilder:package-mgt:writePackageJson] Failed to write package.json.  ${e}`,this.packageJson,t)}}getUibRootPJ(){if(this.uib===void 0)throw this.#i;if(this.log===void 0)throw this.#t;if(this.uib.rootFolder===null)throw this.#s;const e=this.uib.rootFolder,n=r.join(e,this.packageJson);let s=this.readPackageJson(e);return s===null&&(this.log.warn(`[uibuilder:package-mgt:getUibRootPJ] Could not read ${n}. Creating minimal version.`),s={name:"uib_root",version:this.uib.version,description:"Root configuration and data folder for uibuilder",scripts:{},dependencies:{},homepage:"",bugs:"",author:"",license:"Apache-2.0",repository:"",uibuilder:{packages:{}}}),s}async updIndividualPkgDetails(e,n){if(this.uibPackageJson===null)throw new Error("[uibuilder:UibPackages.js:updIndividualPkgDetails] this.uibPackageJson is null");const s=this.uibPackageJson;if(s.uibuilder===void 0||s.uibuilder.packages===void 0||s.dependencies===void 0)throw new Error("pgkMgt:updIndividualPkgDetails: pj.uibuilder, pj.uibuilder.packages or pj.dependencies is undefined");if(!s.dependencies[e])return;const t=s.uibuilder.packages;t[e]={};const i=t[e],a=n.dependencies[e];if(i.spec=s.dependencies[e],a.missing?(i.missing=!0,i.problems=a.problems):(i.installFolder=a.path,i.installedVersion=a.version,a.browser&&typeof a.browser=="string"?i.estimatedEntryPoint=a.browser:a.jsdelivr?i.estimatedEntryPoint=a.jsdelivr:a.unpkg?i.estimatedEntryPoint=a.unpkg:a.main?i.estimatedEntryPoint=a.main:i.estimatedEntryPoint="?",i.estimatedEntryPoint==="none"&&(i.estimatedEntryPoint="?"),a.homepage?i.homepage=a.homepage:i.homepage=`https://www.npmjs.com/search?q=${e}`,i.packageUrl="/"+e,i.url=`../uibuilder/vendor${i.packageUrl}/${i.estimatedEntryPoint}`,e.startsWith("@")&&(i.scope=e.replace(i.packageUrl,""))),s.dependencies[e]&&s.dependencies[e].includes(":"))i.latestVersion=null,i.installedFrom=s.dependencies[e].split(":")[0],i.outdated={};else{i.installedFrom="npm";let o=await this.npmOutdated(e);try{o=JSON.parse(o)}catch{}o[e]&&(o={current:o[e].current,wanted:o[e].wanted,latest:o[e].latest}),i.outdated=o}}async updateInstalledPackageDetails(){const e=this.uibPackageJson;if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw this.#s;const n=this.uib.rootFolder;let s="";try{s=await this.npmListInstalled(n)}catch{}let t={dependencies:{}};try{t=JSON.parse(s)}catch{}const i=Object.keys(t.dependencies||{});await Promise.all(i.map(async a=>{await this.updIndividualPkgDetails(a,t)})),this.writePackageJson(n,e)}getUibRootPackageJson(){if(this.log===void 0)throw this.#t;if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw this.#s;const e=this.log;if(this.#e!==!0)return e.warn("[uibuilder:UibPackages:getUibRootPackageJson] Cannot run. Setup has not been called."),null;const n=this.uib.rootFolder,s=r.join(n,this.packageJson);l.existsSync(s)||(e.warn("[uibuilder:package-mgt:getUibRootPackageJson] No uibRoot/package.json file, creating minimal file."),this.setUibRootPackageJson());let t={};try{t=this.readPackageJson(n)}catch(i){return e.error(`[uibuilder:package-mgt:getUibRootPackageJson] Error reading ${s}. ${i.message}`),this.uibPackageJson=null,null}return t.dependencies||(t.dependencies={}),t.uibuilder||(t.uibuilder={}),t.uibuilder.packages={},this.uibPackageJson.dependencies!==t.dependencies&&(e.info("[uibuilder:package-mgt:getUibRootPackageJson] package.json dependencies changed"),console.info({"pkg-deps":this.uibPackageJson.dependencies,"memory-deps":t.dependencies})),t.version=this.uib.version,Object.keys(t.dependencies).forEach(i=>{t.uibuilder.packages[i]=this.getPackageDetails2(i,n),t.uibuilder.packages[i].spec=t.dependencies[i],i==="bootstrap-vue"&&!t.dependencies.bootstrap&&(t.dependencies.bootstrap=t.uibuilder.packages[i].bootstrap,t.uibuilder.packages.bootstrap=this.getPackageDetails2("bootstrap",n),t.uibuilder.packages.bootstrap.spec=t.dependencies.bootstrap)}),this.setUibRootPackageJson(t)===!0?t:null}setUibRootPackageJson(e){if(this.log===void 0)throw this.#t;if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw this.#s;if(this.#e!==!0){this.log.warn("[uibuilder:UibPackages:setUibRootPackageJson] Cannot run. Setup has not been called.");return}const n=this.uib.rootFolder,s=r.join(n,this.packageJson);e||(log.warn("[uibuilder:package-mgt:setUibRootPackageJson] Using dummy json"),e={name:"uib_root",version:this.uib.version,description:"Root configuration and data folder for uibuilder",scripts:{},dependencies:{},homepage:"",bugs:"",author:"",license:"Apache-2.0",repository:"",uibuilder:{packages:{}}});try{return l.writeJsonSync(s,e,{spaces:2}),this.uibPackageJson=e,!0}catch(t){return log.error(`[uibuilder:package-mgt:setUibRootPackageJson] Error writing ${s}. ${t.message}`),this.uibPackageJson=null,!1}}getPackagePath2(e,n){if(this.log===void 0)throw this.#t;if(this.#e!==!0)return this.log.warn("[uibuilder:UibPackages:getPackagePath] Cannot run. Setup has not been called."),null;Array.isArray(n)||(n=[n]);for(const s of n){const t=r.join(s,"node_modules",e);if(l.existsSync(t))return t}return this.log.warn(`[uibuilder:package-mgt:getPackagePath2] PACKAGE ${e} NOT FOUND`),null}getPackageDetails2(e,n){if(this.log===void 0)throw this.#t;if(this.#e!==!0)return this.log.warn("[uibuilder:UibPackages:getPackagePath2] Cannot run. Setup has not been called."),null;e=e.trim();const s=this.getPackagePath2(e,n);if(s===null)throw new Error("folder is null");const t=this.readPackageJson(s),i={installFolder:s};return t.version&&(i.installedVersion=t.version),t.browser&&typeof t.browser=="string"?i.estimatedEntryPoint=t.browser:t.jsdelivr?i.estimatedEntryPoint=t.jsdelivr:t.unpkg?i.estimatedEntryPoint=t.unpkg:t.main?i.estimatedEntryPoint=t.main:i.estimatedEntryPoint="?",i.estimatedEntryPoint==="none"&&(i.estimatedEntryPoint="?"),t.homepage?i.homepage=t.homepage:i.homepage=`https://www.npmjs.com/search?q=${e}`,i.packageUrl="/"+e,i.packageUrl.startsWith("@")&&(i.packageUrl="/"+e.replace(/^@.*\//,""),i.scope=e.replace(i.packageUrl,"")),i.url=`../uibuilder/vendor${i.packageUrl}/${i.estimatedEntryPoint}`,e==="bootstrap-vue"&&(i.bootstrap=t.dependencies.bootstrap),i}updateInstalledPackages(){this.log.error("[uibuilder:UibPackages:updateInstalledPackages] FUNCTION IS DEPRECATED."),console.trace(),console.trace("package-mgt.js:updateInstalledPackages")}getPackagePath(){this.log.error("[uibuilder:UibPackages:getPackagePath] FUNCTION IS DEPRECATED."),console.trace(),console.trace("package-mgt.js:getPackagePath")}updateMergedPackageList(){this.log.error("[uibuilder:UibPackages:updateMergedPackageList] FUNCTION IS DEPRECATED."),console.trace(),console.trace("package-mgt.js:updateMergedPackageList")}async npmInstallPackage(e,n,s="",t=""){if(this.log===void 0)throw this.#t;if(this.#e!==!0)return this.log.warn("[uibuilder:UibPackages:npmInstallPackage] Cannot run. Setup has not been called."),"";if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw new Error("this.log.rootFolder is null");t===""&&(t=this.uib.rootFolder);const i={cwd:t,all:!0},a=["install","--no-fund","--no-audit","--no-update-notifier","--save","--production","--color=false",n+s],{all:o}=await u("npm",a,i);return this.log.info(`[uibuilder:UibPackages:npmInstallPackage] npm output: 
 ${o}
 `),o}async npmRemovePackage(e){if(this.log===void 0)throw this.#t;if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw this.#s;if(this.#e!==!0)return this.log.warn("[uibuilder:UibPackages:npmRemovePackage] Cannot run. Setup has not been called."),"";const n={cwd:this.uib.rootFolder,all:!0},s=["uninstall","--save","--color=false","--no-fund","--no-audit","--no-update-notifier",e],{all:t}=await u("npm",s,n);return this.log.info(`[uibuilder:UibPackages:npmRemovePackage] npm output: 
 ${t}
 `),t}async npmListInstalled(e){this.log.trace("[uibuilder:package-mgt:npmListInstalled] npm list installed started");const n={cwd:e,all:!0},s=["list","--long","--json","--depth=0"];let t;try{const{stdout:i}=await u("npm",s,n);t=i}catch(i){t=i.stdout}return this.log.trace("[uibuilder:package-mgt:npmListInstalled] npm list installed completed"),t}async npmOutdated(e){if(this.log===void 0)throw this.#t;if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw this.#s;if(this.#e!==!0){this.log.warn("[uibuilder:UibPackages:npmOutdated] Cannot run. Setup has not been called.");return}const n={cwd:this.uib.rootFolder,all:!0},s=["outdated","--json",e];let t;try{const{stdout:i}=await u("npm",s,n);t=i}catch(i){t=i.stdout}return this.log.trace(`[uibuilder:UibPackages:npmOutdated] npm output: 
 ${t}
 `),t}async npmUpdate(e){if(this.log===void 0)throw this.#t;if(this.#e!==!0)return this.log.warn("[uibuilder:UibPackages:npmUpdate] Cannot run. Setup has not been called."),"";if(this.uib===void 0)throw this.#i;if(this.uib.rootFolder===null)throw new Error("this.log.rootFolder is null");const s={cwd:this.uib.rootFolder,all:!0},t=["update","--no-fund","--no-audit","--no-update-notifier","--save","--production","--color=false",e],{all:i}=await u("npm",t,s);return this.log.info(`[uibuilder:UibPackages:npmUpdate] npm output: 
 ${i}
 `),i}}const c=new d;module.exports=c;
//# sourceMappingURL=package-mgt.js.map
