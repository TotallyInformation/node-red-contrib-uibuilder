<!--
    Copyright (c) 2019 Julian Knight (Totally Information)

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<script type="text/javascript">
    'use strict'

    /** @typedef {import("node-red").Red} Red */

    //#region --------- "global" variables for the panel --------- //

    /** Module name must match this nodes html file @constant {string} moduleName */
    var moduleName  = 'uibuilder'
    /** Node's label @constant {string} paletteCategory */
    var nodeLabel  = 'UI Builder'
    /** Node's palette category @constant {string} paletteCategory */
    var paletteCategory  = 'UI Builder'
    /** Node's background color @constant {string} paletteColor */
    var paletteColor  = '#E6E0F8'

    /** placeholder for ACE editor vars - so that they survive close/reopen admin config ui
     * @typedef uiace
     * @type {Object}
     * @property {string} format
     * @property {string} folder
     * @property {string} fname
     */
    var uiace = {
        'format': 'html',
        'folder': 'src',
        'fname' : 'index.html'
    }

    //#endregion ------------------------------------------------- //

    //#region --------- "global" functions for the panel --------- //

    /** AddItem function for package list
     * @param {JQuery<HTMLElement>} element the jQuery DOM element to which any row content should be added
     * @param {number} index the index of the row
     * @param {string|*} data data object for the row. {} if add button pressed, else data passed to addItem method
     */
    function addPackageRow(element,index,data) {
        var hRow = ''

        if (Object.entries(data).length === 0) {
            // Add button was pressed so we have no packageName, create an input form instead
            hRow='<input type="text" id="packageList-input-' + index + '"> <button id="packageList-button-' + index + '">Install</button>'
        } else {
            // addItem method was called with a packageName passed
            hRow = data
        }
        // Build the output row
        var myRow = $('<div id="packageList-row-' + index + '" class="packageList-row-data">'+hRow+'</div>').appendTo(element)

        // Create a button click listener for the install button for this row
        $('#packageList-button-' + index).click(function(){
            //console.log('.packageList-row-data button::click', $('#packageList-input-' + index).val() )

            // show activity spinner
            $('i.spinner').show()
            
            var packageName = '' + $('#packageList-input-' + index).val()

            if ( packageName.length !== 0 ) {
                /** @type {Red} */
                RED.notify('Installing npm package ' + packageName)

                // Call the npm installPackage API (it updates the package list)
                $.get( 'uibnpmmanage?cmd=install&package=' + packageName, function(data){
                    //console.log('.packageList-row-data get::uibnpmmanage', data )

                    if ( data.success === true) {
                        RED.notify('Successful installation of npm package ' + packageName, 'success')
                        console.log('[uibuilder:addPackageRow:get] PACKAGE INSTALLED. ', packageName)

                        // Replace the input field with the normal package name display
                        myRow.html(packageName)
                    } else {
                        RED.notify('FAILED installation of npm package ' + packageName, 'error')
                        console.log('[uibuilder:addPackageRow:get] ERROR ON INSTALLATION OF PACKAGE ', packageName )
                        console.dir( data.result )
                    }

                    // Hide the progress spinner
                    $('i.spinner').hide()

                }).fail(function(_jqXHR, textStatus, errorThrown) {
                    RED.notify('FAILED installation of npm package ' + packageName, 'error')
                    console.error( '[uibuilder:addPackageRow:get] Error ' + textStatus, errorThrown )

                    $('i.spinner').hide()
                    return 'addPackageRow failed'
                    // TODO otherwise highlight input
                })
            } // else Do nothing

        }) // -- end of button click -- //

    } // --- End of addPackageRow() ---- //

    /** RemoveItem function for package list */
    function removePackageRow(packageName) {
        //console.log('[uibuilder:removePackageRow] PACKAGE NAME: ', packageName)

        // If package name is an empty object - user removed an add row so ignore
        if ( (packageName === '') || (typeof packageName !== 'string') ) {
            return false
        }

        RED.notify('Starting removal of npm package ' + packageName)
        // show activity spinner
        $('i.spinner').show()

        // Call the npm installPackage API (it updates the package list)
        $.get( 'uibnpmmanage?cmd=remove&package=' + packageName, function(data){
            //console.log('[uibuilder:removePackageRow:get::uibnpmmanage] ', data )

            if ( data.success === true) {
                RED.notify('Successfully uninstalled npm package ' + packageName, 'success')
                console.log('[uibuilder:removePackageRow:get] PACKAGE REMOVED. ', packageName)
            } else {
                RED.notify('FAILED to uninstall npm package ' + packageName, 'error')
                console.log('[uibuilder:removePackageRow:get] ERROR ON PACKAGE REMOVAL ', data.result )
                // Put the entry back again
                $('#node-input-packageList').editableList('addItem',packageName)
            }

            $('i.spinner').hide()

        }).fail(function(_jqXHR, textStatus, errorThrown) {
            RED.notify('FAILED to uninstall npm package ' + packageName, 'error')
            console.error( '[uibuilder:removePackageRow:get] Error ' + textStatus, errorThrown )
            
            // Put the entry back again
            $('#node-input-packageList').editableList('addItem',packageName)

            $('i.spinner').hide()
            return 'removePackageRow failed'
            // TODO otherwise highlight input
        })
        
    } // ---- End of removePackageRow ---- //

    /** Get full package list via API and show in admin ui
     * param {string} url 
     * param {boolean} rebuild - Rebuild the vendorPaths list
     */
    function packageList() {
        $.getJSON('uibvendorpackages', function(vendorPaths) {
            //console.log('uibuilder:packageList:uibvendorpackages', vendorPaths)

            $('#node-input-packageList').editableList('empty')

            var pkgList = Object.keys(vendorPaths)
            pkgList.forEach(function(packageName,_index){
                if ( packageName !== 'socket.io' )
                    $('#node-input-packageList').editableList('addItem',packageName)
            })
        })
    } // --- End of packageList --- //

    /** Return a file type from a file name (or default to txt)
     *  ftype can be used in ACE editor modes */
    function fileType(fname) {
        var fparts = fname.split('.')
        if (fparts.length > 1) {
            var ftype = 'text'
            var fext = fparts[1].toLowerCase().trim()
            switch (fext) {
                case 'js':
                    ftype = 'javascript'
                    break
                case 'html':
                case 'css':
                case 'json':
                    ftype = fext
                    break
                case 'vue':
                    ftype = 'html'
                    break
                case 'md':
                    ftype = 'markdown'
                    break
                case 'yaml':
                case 'yml':
                    ftype = 'yaml'
                    break
                default:
                    // txt
            }
            return ftype
        } else {
            return 'text'
        }
    } // --- End of fileType --- //

    /** Get the list of files for the chosen url & folder
     * @param {string} [selectedFile] Optional. If present will select this filename after refresh, otherwise 1st file is selected.
     */
    function getFileList(selectedFile) {
        $('#node-input-filename option').remove()

        var url = $('#node-input-url').val()
        var folder = $('#node-input-folder').val()

        // Whether or not to force the index.(html|js|css) files to be copied over if missing
        var nodeInputCopyIndex = $('#node-input-copyIndex').is(':checked')

        // Build the file list - pass the url so the BE can find the right folder
        $.getJSON('uibfiles?url=' + url + '&folder=' + folder + '&cpyIdx=' + nodeInputCopyIndex, function(files) {
            var firstFile = '', indexHtml = false, selected = false

            $.each(files, function (i, fname) {
                // Choose the default file. In order: selectedFile param, index.html, 1st returned
                if ( i === 0 ) firstFile = fname
                if ( fname === 'index.html' ) indexHtml = true
                if ( fname === selectedFile ) selected = true
                // Build the drop-down
                $('#node-input-filename').append($('<option>', { 
                    value: fname,
                    text : fname, 
                }))
            })

            //console.log( '[uibuilder:getFileList:getJSON] Got files ', files, firstFile, folder, url )

            // Set default file name/type. In order: selectedFile param, index.html, 1st returned
            if ( selected === true ) uiace.fname = selectedFile
            else if ( indexHtml === true ) uiace.fname = 'index.html'
            else uiace.fname = firstFile
            $('#node-input-filename').val(uiace.fname)
            uiace.format = firstFile === '' ? 'text' : fileType(firstFile)
        }).fail(function(_jqXHR, textStatus, errorThrown) {
            console.error( '[uibuilder:getFileList:getJSON] Error ' + textStatus, errorThrown )
            uiace.fname = ''
            uiace.format = 'text'
        }).always(function() {
            getFileContents()
            fileIsClean(true)
        })
    }

    /** Get the chosen file contents & set up the ACE editor */
    function getFileContents() {
        /** Get the chosen folder name - use the default/last saved on first load 
         * @type {string} */ 
         // @ts-ignore
        var folder = $('#node-input-folder').val() || uiace.folder 
        /** Get the chosen filename - use the default/last saved on first load 
         * @type {string} */
         // @ts-ignore
        var fname = $('#node-input-filename').val() || uiace.fname
        // Get the current url
        var url = $('#node-input-url').val()

        //console.log( '[uibuilder:getFileContents] ', url, folder, fname )

        // Save the file & folder names
        uiace.folder = folder
        uiace.fname = fname

        // Change mode to match file type
        var filetype = fname === '' ? 'text' : fileType(fname)
        $('#node-input-format').val(filetype)

        // Get the file contents via API defined in uibuilder.js
        $.get( 'uibgetfile?url=' + url + '&fname=' + fname + '&folder=' + folder, function(data){
            //console.log( '[uibuilder:getFileContents:get] Success. ', url, folder, fname )
            // Add the fetched data to the editor
            uiace.editorSession.setValue(data)
            // Set the editor file mode
            uiace.editorSession.setMode({
                path: 'ace/mode/' + filetype, v: Date.now()
            })
            // Mark the current session as clean
            uiace.editorSession.getUndoManager().isClean()
            // Position the cursor in the edit area
            uiace.editor.focus()
        }).fail(function(_jqXHR, textStatus, errorThrown) {
            console.error( '[uibuilder:getFileContents:get] Error ' + textStatus, errorThrown )
            uiace.editorSession.setValue('')
        })
    } // --- End of getFileContents --- //

    /** Call admin API to create a new file 
     * @param {string} fname Name of new file to create (combines with current selected folder and the current uibuilder url)
     * @return {string} Status message
     * 
     */
    function createNewFile(fname) {
        // Also get the current folder & url
        var folder = $('#node-input-folder').val() || uiace.folder
        var url = $('#node-input-url').val()

        var apiUrl = 'uibnewfile?url=' + url + '&fname=' + fname + '&folder=' + folder

        $.get( apiUrl, function(_data){
            // Rebuild the file list & select the file
            getFileList(fname)

            return 'Create file succeeded'
        }).fail(function(_jqXHR, textStatus, errorThrown) {
            console.error( '[uibuilder:createNewFile:get] Error ' + textStatus, errorThrown )
            return 'Create file failed'
        })
    } // --- End of createNewFile --- //

    /** Call admin API to delete the currently selected file 
     * @return {string} Status message
     */
    function deleteFile() {
        // Get the current file, folder & url
        var fname = $('#node-input-filename').val()
        var folder = $('#node-input-folder').val()
        var url = $('#node-input-url').val()

        var apiUrl = 'uibdeletefile?url=' + url + '&fname=' + fname + '&folder=' + folder

        $.get( apiUrl, function(_data){
            // Rebuild the file list & select the file
            getFileList(fname)

            return 'Delete file succeeded'
        }).fail(function(_jqXHR, textStatus, errorThrown) {
            console.error( '[uibuilder:deleteFile:get] Error ' + textStatus, errorThrown )
            return 'Delete file failed'
        })
    } // --- End of deleteFile --- //

    /** Enable/disable buttons if file has edits or not
     * @param {boolean} isClean true = the file is clean, else there are pending edits that need saving
     */
    function fileIsClean(isClean) {
        // If clean, disable the save & reset buttons
        $('#edit-save').prop('disabled', isClean)
        $('#edit-reset').prop('disabled', isClean)
        // If clean, enable the delete and edit buttons
        //$('#edit-delete').prop('disabled', !isClean)
        $('#edit-close').prop('disabled', !isClean)
        $('#node-edit-file').prop('disabled', !isClean)
        $('#node-input-filename').prop('disabled', !isClean)
        // If not clean, disable main Done and Cancel buttons to prevent loss
        $('#node-dialog-ok').prop('disabled', !isClean)
        $('#node-dialog-cancel').prop('disabled', !isClean)
        // If not clean, Add a user hint
        if ( ! isClean ) {
            $('#file-action-message').text('Save Required')
            $('#node-dialog-ok').css( 'cursor', 'not-allowed' )
            $('#node-dialog-cancel').css( 'cursor', 'not-allowed' )
        } else {
            $('#node-dialog-ok').css( 'cursor', 'pointer' )
            $('#node-dialog-cancel').css( 'cursor', 'pointer' )
        }
    } // --- End of fileIsClean --- //

    /** Validation Function: Validate the url property
     * Max 20 chars, can't contain any of ['..', ]
     * @param {*} value The url value to validate
     * @returns {boolean} true = valid
     **/
    function validateUrl(value) {
        // NB: `this` is the node instance configuration as at last press of Done
        // TODO: Add display comment to help user

        // Max 20 chars
        if ( value.length > 20 ) return false
        // Cannot contain ..
        if ( value.indexOf('..') !== -1 ) return false
        // cannot contain / or \
        if ( value.indexOf('/') !== -1 ) return false
        if ( value.indexOf('\\') !== -1 ) return false
        // Cannot start with _ or .
        if ( value.substring(0,1) === '_' ) return false
        if ( value.substring(0,1) === '.' ) return false
        // Cannot be 'templates' as this is a reserved value (for v2)
        if ( value.toLowerCase().substring(0,9) === 'templates' ) return false

        // Initial flow run and Initial load of admin config ui - don't check for dups as it always will be
        if ( value === this.url ) return true
        
        // Check whether the url is already in use via a call to the admin API `uibindex`
        var exists = false
        $.ajax({
            dataType: 'json', async: false, 
            url: 'uibindex?check=' + value,
            success: function(check) {
                exists = check
            }
        })

        /** If the url already exists - prevent the "Done" button from being pressed. */
         // @ts-ignore ts(2367)
        if ( exists === true ) {
            $('#node-dialog-ok').prop('disabled', true)
            $('#node-dialog-ok').css( 'cursor', 'not-allowed' )
            return false
        } else {
            $('#node-dialog-ok').prop('disabled', false)
            $('#node-dialog-ok').css( 'cursor', 'pointer' )
            return true
        }

    } // --- End of validateUrl --- //

    /** Set the height of the ACE text editor box */
    function setACEheight() {
        var height

        if ( uiace.editorLoaded === true ) {
            if (document.fullscreenElement) {
                // Force background color and add some padding to keep away from edge
                $('#edit-props').css('background-color','#f6f6f6').css('padding','1em')

                // Calculate the available height and adjust the editor to fill the ht
                height = parseInt($('#edit-props').css('height')) // full available height
                height -= 25

                //console.log('Entered full-screen mode. Element: ', document.fullscreenElement.id, height)

            } else {
                $('#edit-props').css('background-color','').css('padding','')

                // Full height
                height = parseInt($('#dialog-form').height())
                // Subtract info lines
                height -= parseInt($('#info').height())

                //console.log('Leaving full-screen mode.', height)
                
            }
            
            // everything but the edit box
            var rows = $('#edit-props > div:not(.node-text-editor-row)')

            // subtract height of each row from the total
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true)
            }

            // Set the height of the edit box
            $('#node-input-template-editor').css('height',height+'px')

            // Get the content to match the edit box size
            uiace.editor.resize()

        }

    } // --- End of setACEheight --- //

    //#endregion ------------------------------------------------- //

    // Register the node type, defaults and set up the edit fns 
     //@ts-ignore 
    RED.nodes.registerType(moduleName, {
        category: paletteCategory,
        color: paletteColor,
        defaults: {
            name: { value: '' },
            topic: { value: '' },
            url: { value: 'uibuilder', required: true, validate: validateUrl },
            fwdInMessages: { value: false },   // Should we send input msg's direct to output as well as the front-end?
            allowScripts: { value: false },    // Should we allow msg's to send JavaScript to the front-end?
            allowStyles: { value: false },     // Should we allow msg's to send CSS styles to the front-end?
            copyIndex: { value: true },        // Should the default template files be copied to the instance src folder?
            showfolder: { value: false },      // Should a web index view of all source files be made available?
        },
        inputs: 1,
        inputLabels: 'Msg to send to front-end',
        outputs: 2,
        outputLabels: ['Data from front-end', 'Control Msgs from front-end'],
        icon: 'ui_template.png',
        paletteLabel: nodeLabel,
        label: function () { return this.url || this.name || nodeLabel },

        /** Prepares the Editor panel */
        oneditprepare: function () {
            var that = this

            //#region Start with the edit section hidden & main section visible
            $('#main-props').show()
            $('#edit-props').hide()
            $('#npm-props').hide()
            $('#adv-props').hide()
            $('#info-props').hide()
            //#endregion

            //#region Set the checkbox states
            $('#node-input-fwdInMessages').prop('checked', this.fwdInMessages)
            $('#node-input-allowScripts').prop('checked', this.allowScripts)
            $('#node-input-allowStyles').prop('checked', this.allowStyles)
            $('#node-input-copyIndex').prop('checked', this.copyIndex)
            //#endregion checkbox states

            // When the url changes (NB: Also see the validation function)
            $('#node-input-url').change(function () {
                // Show the root URL
                 // @ts-ignore Cannot find name 'RED'.ts(2304)
                $('#uibuilderurl').empty().append('<a href="' + RED.settings.httpNodeRoot + $(this).val() + '" target="_blank">' + RED.settings.httpNodeRoot + $(this).val() + '</a>')
                $('#node-input-showfolder-url').empty().append('<a href="' + RED.settings.httpNodeRoot + $(this).val() + '/idx" target="_blank">' + RED.settings.httpNodeRoot + $(this).val() + '/idx</a>')
            })

            // Show/Hide the advanced settings
            $('#show-adv-props').css( 'cursor', 'pointer' )
            $('#show-adv-props').click(function(_e) {
                $('#adv-props').toggle()
                if ( $('#adv-props').is(':visible') ) {
                    $('#show-adv-props').html('<i class="fa fa-caret-down"></i> Advanced Settings')
                } else {
                    $('#show-adv-props').html('<i class="fa fa-caret-right"></i> Advanced Settings')
                }
            })

            //#region ---- File Editor ---- //
            // Mark edit save/reset buttons as disabled by default
            fileIsClean(true)

            // Show the edit section, hide the main & adv sections
            $('#show-edit-props').click(function(e) {
                e.preventDefault() // don't trigger normal click event
                $('#main-props').hide()
                $('#adv-props').hide()
                $('#show-adv-props').html('<i class="fa fa-caret-right"></i> Advanced Settings')
                $('#edit-props').show()

                // Make the horizontal separator draggable
                $('#node-input-template-editor').resizable({
                    'handles': 's'
                })
                $('#node-input-template-editor > div.ui-resizable-handle.ui-resizable-s').css({
                    'height': '25px',
                    'bottom': '-25px'
                })

                // @since 2019-01-27 - adding file editor
                // Build the file list
                getFileList()

                if ( uiace.editorLoaded !== true ) {
                    // Clear out the editor
                        // @ts-ignore ts(2367)
                    if ($('#node-input-template').val('') !== '') $('#node-input-template').val('')

                    // Create the ACE editor component
                        //@ts-ignore Cannot find name 'RED'.ts(2304)
                    uiace.editor = RED.editor.createEditor({
                        id: 'node-input-template-editor',
                        mode: 'ace/mode/' + uiace.format,
                        value: that.template
                    })
                    // Keep a reference to the current editor session
                    uiace.editorSession = uiace.editor.getSession()
                    /** If the editor has changes, enable the save & reset buttons
                     * using input event instead of change since it's called with some timeout 
                     * which is needed by the undo (which takes some time to update)
                     **/
                    uiace.editor.on('input', function() {
                        // Is the editor clean?
                        fileIsClean(uiace.editorSession.getUndoManager().isClean())
                    })
                    /*uiace.editorSession.on('change', function(delta) {
                        // delta.start, delta.end, delta.lines, delta.action
                        console.log('ACE Editor CHANGE Event', delta)
                    }) */
                    uiace.editorLoaded = true

                    // Resize to max available height
                    setACEheight()
                    
                    // Be friendly and auto-load the initial file via the admin API
                    getFileContents()
                    fileIsClean(true)
                }
            })

            // Hide the edit section, show the main section
            $('#edit-close').click(function(e) {
                e.preventDefault() // don't trigger normal click event
                $('#main-props').show()
                $('#edit-props').hide()
            })

            // Handle the file editor change of folder/file
            $('#node-input-folder').change(function(_e) {
                // Rebuild the file list
                getFileList()
            })
            $('#node-input-filename').change(function(_e) {
                // Get the content of the file via the admin API
                getFileContents()
                fileIsClean(true)
            })
            // Handle the file editor reset button (reload the file)
            $('#edit-reset').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                // Get the content of the file via the admin API
                getFileContents()
                fileIsClean(true)
                $('#file-action-message').text('')
            })
            // Handle the file editor save button
            $('#edit-save').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                var authTokens = RED.settings.get('auth-tokens')
                
                // Post the updated content of the file via the admin API
                // NOTE: Cannot use jQuery POST function as it sets headers that trigger a CORS error. Do it using native requests only.
                var request = new XMLHttpRequest()
                var params = 'fname=' + $('#node-input-filename').val() + '&folder=' + $('#node-input-folder').val() + 
                    '&url=' + $('#node-input-url').val() + '&data=' + encodeURIComponent(uiace.editorSession.getValue())
                request.open('POST', 'uibputfile', true)
                request.onreadystatechange = function() {
                    if (this.readyState === XMLHttpRequest.DONE) {
                        if (this.status === 200) {
                            // Request successful
                            // display msg - blank msg when new edits present
                            $('#file-action-message').text('File Saved')
                            fileIsClean(true)
                        } else {
                            // Request failed
                            // display msg - blank msg when new edits present
                            $('#file-action-message').text('File Save FAILED')
                        }
                    }
                }
                request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
                // If admin ui is protected with a login, we need to send the access token
                if (authTokens) request.setRequestHeader('Authorization', 'Bearer ' + authTokens.access_token)
                request.send(params)

            })

            //#region Handle the Delete file button
            $('#edit_delete_dialog').dialog({
                autoOpen:false, modal:true, closeOnEscape:true,
                buttons: [
                    {
                        text: 'Delete',
                        id: 'edit_del_dialog_del',
                        click: function() {
                            // Call the delete file API (uses the current file)
                            deleteFile()
                            $( this ).dialog( 'close' )
                        }
                    },{
                        text: 'Cancel',
                        click: function() {
                            $( this ).dialog( 'close' )
                        }
                    },
                ]
            })
            $('#edit-delete').click(function(_e) {
                $('#edit_del_dialog_del').addClass('input-error').css('color','brown')
                $('#edit-delete-name').text($('#node-input-folder').val() + '/' + $('#node-input-filename').val())
                if ( $('#node-input-folder').val() === 'src' ) {
                    if ( $('#node-input-copyIndex').is(':checked') ) {
                        $('#edit-delete-recopy').css('color','').text('Copy flag is set so index.(html|js|css) files will be recopied from master template.')
                    } else {
                        $('#edit-delete-recopy').css('color','brown').text('Copy flag is NOT set so index.(html|js|css) files will NOT be recopied from master template.')
                    }    
                } else {
                    $('#edit-delete-recopy').css('color','').text('')
                }
                $('#edit_delete_dialog').dialog('open')  
            })
            //#endregion

            //#region Handle the New file button
            $('#edit_new_dialog_new').addClass('input-error').prop('disabled',true)
            $('#edit-input-newname').addClass('input-error').on('input', function(){
                if ( $('#edit-input-newname').val().length === 0) {
                    $('#edit-input-newname').addClass('input-error')
                    $('#edit_new_dialog_new').addClass('input-error').prop('disabled',true)
                } else {
                    $('#edit-input-newname').removeClass('input-error')
                    $('#edit_new_dialog_new').removeClass('input-error').prop('disabled',false)
                }
            })
            $('#edit_new_dialog').dialog({
                autoOpen:false, modal:true, closeOnEscape:true,
                buttons: [
                    {
                        text: 'Create',
                        id: 'edit_new_dialog_new',
                        click: function() {
                            // NB: Button is disabled unless name.length > 0 so don't need to check here
                            // Call the new file API
                            createNewFile($('#edit-input-newname').val())
                            $('#edit-input-newname').val(null).addClass('input-error')
                            $('#edit_new_dialog_new').addClass('input-error').prop('disabled',true)
                            $( this ).dialog( 'close' )
                        }
                    },{
                        text: 'Cancel',
                        click: function() {
                            $('#edit-input-newname').val(null).addClass('input-error')
                            $('#edit_new_dialog_new').addClass('input-error').prop('disabled',true)
                            $( this ).dialog( 'close' )
                        }
                    },
                ]
            })
            $('#edit-new').click(function(_e) {
                $('#edit_new_dialog').dialog('open')  
            })
            //#endregion

            // Handle the expander button (show full screen editor) - from core function node
            $('#node-function-expand-js').click(function(e) {
                e.preventDefault()
                var value = uiace.editor.getValue()
                //uiace.editorSession

                // TODO: Don't use editJavaScript as it might not be! Need to rewrite.
                console.log('**** ' + uiace.format + ' **** ', uiace.editor)

                // Select the editor components and make full-screen
                var viewer = $('#edit-props')[0]
                var rFS = viewer.requestFullscreen || viewer.mozRequestFullScreen || viewer.webkitRequestFullscreen || viewer.msRequestFullScreen
                if (rFS) rFS.call(viewer)
                
                // TODO: Add popup if no method is available

                // RED.editor.editJavaScript({
                //     value: value,
                //     width: 'Infinity',
                //     cursor: uiace.editor.getCursorPosition(),
                //     mode: 'ace/mode/' + uiace.format,
                //     complete: function(v,cursor) {
                //         uiace.editor.setValue(v, -1)
                //         uiace.editor.gotoLine(cursor.row+1,cursor.column,false)
                //         setTimeout(function() {
                //             uiace.editor.focus()
                //         },300)
                //     }
                // })
            })
            //#endregion ---- File Editor ---- //

            //#region ---- npm ---- //
            // NB: Assuming that the edit section is closed
            // Show the npm section, hide the main & adv sections
            $('#show-npm-props').click(function(e) {
                e.preventDefault() // don't trigger normal click event
                $('#main-props').hide()
                $('#adv-props').hide()
                $('#show-adv-props').html('<i class="fa fa-caret-right"></i> Advanced Settings')
                $('#npm-props').show()

                // TODO Improve feedback
                //#region Setup the package list
                $('#node-input-packageList').editableList({
                    addItem: addPackageRow, // function
                    removeItem: removePackageRow, // function(data){},
                    resizeItem: function(_row,_index) {},
                    header: $('<div>').append('<h4 style="display: inline-grid">Installed Packages</h4>'),
                    height: 'auto',
                    addButton: true,
                    removable: true,
                    scrollOnAdd: true,
                    sortable: false,
                })

                /** Initialise default values for package list
                 * NOTE: This is build dynamically each time the edit panel is opened
                 *       we are not saving this since external changes would result in
                 *       users having being prompted to deploy even when they've made
                 *       no changes themselves to a node instance.
                 */
                packageList()

                // spinner
                $('.red-ui-editableList-addButton').after(' <i class="spinner"></i>')
                $('i.spinner').hide()
                //#endregion --- package list ---- //

            })
            // Hide the npm section, show the main section
            $('#npm-close').click(function(e) {
                e.preventDefault() // don't trigger normal click event

                $('#main-props').show()
                $('#npm-props').hide()
            })
            //#endregion ---- npm ---- //

            /** TODO: Get list of installed ACE themes, add chooser, save current choice
             * that.editor.setTheme("ace/theme/monokai")
             * uiace.config.set("basePath", "https://url.to.a/folder/that/contains-ace-modes");
             * uiace.config.setModuleUrl("ace/theme/textmate", "url for textmate.js");
             **/

        }, // ---- End of oneditprepare ---- //

        /** Runs before save */
        oneditsave: function() {
            // xfer the editor text back to the template var
            //$('#node-input-template').val(this.editor.getValue())
            // Get rid of the editor
            if ( uiace.editorLoaded === true ) {
                uiace.editor.destroy()
                delete uiace.editor
                uiace.editorLoaded = false
            }
        }, // ---- End of oneditsave ---- //

        /** Runs before cancel */
        oneditcancel: function() {
            // Get rid of the editor
            if ( uiace.editorLoaded === true ) {
                uiace.editor.destroy()
                delete uiace.editor
                uiace.editorLoaded = false
            }
        }, // ---- End of oneditcancel ---- //

        /** Handle window resizing for the editor */
        oneditresize: function(_size) {
            console.log('RESIZE', _size)

            setACEheight()

        }, // ---- End of oneditcancel ---- //

    }) // ---- End of registerType() ---- //

</script>

<script type="text/x-red" data-template-name="uibuilder">
    <div id="main-props"><!-- Hideable main properties section -->
        <!-- Node Name -->
        <div class="form-row">
            <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
            <input type="text" id="node-input-name">
        </div>

        <!-- Topic -->
        <div class="form-row" title="Adds a msg.topic to input msgs if not already provided">
            <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
            <input type="text" id="node-input-topic">
        </div>

        <!-- Home "page" id - defines the URL used -->
        <div class="form-row" title="Make sure this gives a unique URL">
            <label for="node-input-url"><i class="fa fa-globe"></i> URL</label>
            <input type="text" id="node-input-url" title="required, <20 chars, unique, cannot be 'templates'">
        </div>

        <!-- Buttons to show "edit src files" & "mng front-end libs", hide this section -->
        <div class="form-row">
            <button class="btn" id="show-edit-props" title="Edit the front-end code">Edit Source Files</button>
            <button class="btn" id="show-npm-props" title="Install/remove/update npm packages to use with your UI">Manage front-end libraries</button>
        </div>

        <!-- Show advanced edit properties -->
        <div class="form-row">
            <h5 id="show-adv-props" title="Show/Hide the advanced configuration settings">
                <i class="fa fa-caret-right"></i> Advanced Settings
            </h5>
        </div>

    </div>

    <!-- ---- Hideable Advanced Settings Section ---- -->
    <div id="adv-props" style="display:hidden;border-bottom:1px solid silver;margin-bottom:.5em;">
        <!-- Allow scripts/styles to be passed to front-end? -->
        <div class="form-row" title="Add msg.script/msg.style to the input msg">
            Allow passing to the front-end: 
            <input type="checkbox" id="node-input-allowScripts" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-allowScripts" style="">Scripts? (JS)</label>
            <input type="checkbox" id="node-input-allowStyles" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-allowStyles" style="">Styles? (CSS)</label>
        </div>

        <!-- Copy index.(html|css|js) to local assets if they dont exist? -->
        <div class="form-row">
            <input type="checkbox" id="node-input-copyIndex" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-copyIndex" style="width: 90%;">Copy index.(html|css|js) from templates to this instance if they don't exist?</label>
        </div>

        <!-- Provide a searchable file index view? -->
        <div class="form-row">
            <input type="checkbox" id="node-input-showfolder" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-showfolder" style="width: 90%;">Show web view of source files at <span id="node-input-showfolder-url">_</span>.</label>
        </div>

        <div class="form-tips node-help" title="">
            Warning: Most people will not need these settings.
        </div>
        <!-- Forward flag -->
        <div class="form-row">
            <!-- Forward input msgs to output -->
            <input type="checkbox" id="node-input-fwdInMessages" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-fwdInMessages" style="width: 40%;" title="forward inbound msg's direct to the output">
                Forward input to output?
            </label>
        </div>
    </div>

    <!-- ---- Hideable File Editor Section ---- -->
    <div id="edit-props">
        <!-- Drop-down for selecting folder -->
        <div class="form-row" title="Choose between the src, dist (built src) or root folders">
            <label for="node-input-folder"><i class="fa fa-folder-open-o"></i> Folder:</label>
            <select id="node-input-folder" style="width: 75%;">
                <option value="src">src</option>
                <option value="dist">dist</option>
                <option value="root">root</option>
            </select>
        </div>
        <!-- Drop-down for selecting file to edit -->
        <div class="form-row">
            <label for="node-input-filename"><i class="fa fa-file-code-o"></i> File:</label>
            <select id="node-input-filename" style="width: 75%;"></select>
        </div>

        <!-- Save/Reset/close/(message)/Delete -->
        <div class="form-row">
            <button class="btn" id="edit-save" title="Save any changes to the file" style="font-size:0.8em;line-height:1em;">Save</button>
            <button class="btn" id="edit-reset" title="Reset any changes to last saved version (cancel changes)" style="font-size:0.8em;line-height:1em;">Reset</button>
            <button class="btn" id="edit-close" title="Close the edit window (lose any unsaved changes)" style="font-size:0.8em;line-height:1em;">Close</button>

            <span id="file-action-message"></span>

            <div style="position: absolute;right:1.6em;display:inline-block;">
                <button class="btn" id="edit-new" title="Add a new file." style="font-size:0.8em;line-height:1em;">
                    New
                </button>
                <div id="edit_new_dialog" title="Create a new file" dialog>
                    <label for="edit-input-newname">New File Name</label>
                    <input type="text" id="edit-input-newname">
                </div>                  
                <button class="btn" id="edit-delete" title="Delete the file. Will reset to the default template if Copy from templates flag is set." style="font-size:0.8em;line-height:1em;">
                    Delete
                </button>
                <div id="edit_delete_dialog" title="Delete the currently selected file" dialog>
                    <h5>File to be deleted</h5>
                    <p id="edit-delete-name"></p>
                    <p id="edit-delete-recopy"></p>
                    <p style="border:2px solid brown;color:brown;font-weight:bold;padding:5px 5px;">Warning: This action cannot be undone.</p>
                </div>                  
            </div>
        </div>

        <!-- Edit box  editor-tray-content -->
        <div id="edit-outer" class="form-row node-text-editor-row" style="position:relative">
            <div style="height: 350px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
            <div id="edit-drag-y" class="red-ui-panels-separator" style="position: relative;"></div>
        </div>

        <!-- file data (hidden), language selector -->
        <div class="form-row">
            <button id="node-function-expand-js" class="editor-button editor-button-small"><i class="fa fa-expand"></i></button>
            <input type="hidden" id="node-input-template" autofocus="autofocus" data-isClean="true">
            <div style="position: absolute; right:1.6em;display:inline-block; text-align: right; font-size: 0.8em;">
                <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                    <option value="handlebars">mustache</option>
                    <option value="html">HTML</option>
                    <option value="json">JSON</option>
                    <option value="javascript">Javascript</option>
                    <option value="css">CSS</option>
                    <option value="markdown">Markdown</option>
                    <option value="yaml">YAML</option>
                    <option value="text">Text</option>
                </select>
            </div>
        </div>
    </div>

    <!-- ---- Hideable NPM Section ---- -->
    <div id="npm-props">
        <h4>Front-End Library Manager</h4>
        <p>
            Install, remove or update npm packages that provide front-end libraries such as
            VueJS, jQuery, MoonJS, etc.
        </p>
        <p>
            You can search for packages on the 
            <a href="https://www.npmjs.com/" target="_blank">official npm site</a> 
            or on <a href="https://npms.io/" target="_blank">npms.io</a>.
            Take the name and paste it below then use one of the buttons.
        </p>
        <!-- Package List -->
        <div class="form-row">
            <ol id="node-input-packageList"></ol>
        </div>
        <!-- Close Button -->
        <div class="form-row">
            <button class="btn" id="npm-close" title="Close the library"">Close Library Manager</button>
        </div>
    </div>

    <!-- Info -->
    <div id="info">
        <div title="Open the uibuilder web page">Web Page URL: <span id="uibuilderurl"></span></div>
        <div title="Shows available libraries, configuration and other detailed uibuilder information">
            <a href="uibindex" target="_blank">Detailed Information</a>
        </div>
    </div>

</script>

<script type="text/x-red" data-help-name="uibuilder">
    <p>Easily create a UI (web app) at a <a href="/uibuilder" target="_blank">given URL</a></p>
    <p>
        Create dynamic user interfaces that send and receive messages to/from Node-RED.
        Creates a file/folder structure that is used to deliver static resources (html, css, js, images, etc) and
        manages the delivery of vendor library resources (VueJS, jQuery, etc).
        You can also pass script and style information to the front-end in a message.
    </p>

    <h3>Input msg</h3>
    <dl class="message-properties">
        <dt class="optional">payload <span class="property-type">(string | buffer)</span></dt>
        <dd> Optionally, the payload of the message to send to all connected client browser tabs. </dd>
        <dt class="optional">topic <span class="property-type">(string)</span></dt>
        <dd> Optionally, the MQTT topic to use. Takes preference over the topic defined in settings.</dd>

        <dt class="optional">script <span class="property-type">(string | string[])</span></dt>
        <dd>
        Optionally, a string or array of strings containing valid JavaScript.
        This will be added to the web page dynamically. Currently contains minimal validation so care is required.
        This feature is <b>off</b> by default, turn on in the Advanced Settings.
        </dd>
        <dt class="optional">style <span class="property-type">(string | string[])</span></dt>
        <dd>
        Optionally, a string or array of strings containing valid CSS for styling the front-end page.
        This will be added to the web page dynamically. Currently contains minimal validation so care is required.
        This feature is <b>off</b> by default, turn on in the Advanced Settings.
        </dd>
    </dl>

    <h3>Output msgs</h3>
    <ol class="node-ports">
        <li>Standard output msg
            <dl class="message-properties">
                <dt>payload <span class="property-type">(string | buffer)</span></dt>
                <dd>
                    A copy of any inbound payload unless altered by the front-end page.
                </dd>
                <dt>topic <span class="property-type">(string)</span></dt>
                <dd>
                    A copy of any inbound topic if present. Otherwise, the topic from the node's settings. Could be changed by the front-end
                    page but it really isn't recommended.
                </dd>
                <dt>_socketId <span class="property-type">(string)</span></dt>
                <dd>
                    Identifies the sending browser/tab. Retain this if needing to send a reply back to the originator.
                    Remove if needing to send a reply to all connected broweser/tabs.
                    Note that the initial part of the ID contains the source URI.
                </dd>
                <dt>other</dt>
                <dd>
                    Note that any inbound msg.script or msg.style is stripped and not sent to the output.
                </dd>
            </dl>
        </li>
        <li>Control output msg
            <dl class="message-properties">
                <dt>uibuilderCtrl <span class="property-type">(string)</span></dt>
                <dd>
                    The name of the control message. See the
                    <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki/Control-Message-Structure" target="_blank">WIKI page</a>
                    for details.
                </dd>
                <dt>cache-control <span class="property-type">(string)</span></dt>
                <dd>
                    "REPLAY". A command for the companion app
                    <a href="https://github.com/TotallyInformation/node-red-contrib-infocache" target="_blank">node-red-contrib-infocache</a>.
                    See the
                    <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki/Message-Caching" target="_blank">WIKI</a>
                    for details.
                </dd>
                <dt>from <span class="property-type">(string)</span></dt>
                <dd>
                    Identifies the source of the msg since both <i>server</i> (back-end) and <i>client</i> (front-end) control messages
                    will appear out of port #2.
                </dd>
                <dt>_socketId <span class="property-type">(string)</span></dt>
                <dd>
                    Identifies the sending browser/tab. Retain this if needing to send a reply back to the originator.
                    Remove if needing to send a reply to all connected broweser/tabs.
                    Note that the initial part of the ID contains the source URI.
                </dd>
            </dl>
    </ol>

    <h3>Node Settings</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">(string) node-input-name</span></dt>
        <dd>A short description shown in the admin interface</dd>
        <dt>Topic <span class="property-type">(string) node-input-topic</span></dt>
        <dd>A topic name to use if the incoming msg does not contain one.</dd>
        <dt>URL <span class="property-type">(string) node-input-url</span></dt>
        <dd>
            The URL path that the resulting page and other resources will be served from.
            Must be unique across Node-RED. Will also use the Node-RED scheme (http/https)
            and port. Will also be prefixed by the Node-RED setting <i>httpNodeRoot</i>.<br>
            The default URL is <a href="/uibuilder" target="_blank">/uibuilder</a>.<br>
            The url is also used to define the server filing system path for front-end code files.<br>
            The url must be valid as a filename as well as a url path. It may not exceed 20 characters.
        </dd>

        <dt>Edit Source Files <span class="property-type">(button)</span></dt>
        <dd>
            Clicking this button will hide the above settings and display a file editor allowing you
            to edit the front-end files that define your user interface.<br>
            All text-based files in the `<userDir>/uibuilder/<url>/src` folder on the server's filing system will
            be available to edit.<br>
            Note that you can expand the edit panel by clicking on the <kbd class="help-key">&#x2921;</kbd> arrow button underneath the panel.
            To return back, click the red <kbd class="help-key">Done</kbd> or grey <kbd class="help-key">Cancel</kbd> buttons.
        </dd>
        <dt>Manage Front-End Libraries <span class="property-type">(button)</span></dt>
        <dd>
            Clicking this button will hide the above settings and display a list of currently available
            front-end library packages. This interface allows you to add, remove and update any library
            that can be installed via <a href="https://www.npmjs.com/" target="_blank">npm</a>.
        </dd>

    </dl>
        <h4>Advanced Settings</h4>
        <dl class="message-properties">
            <dt>Allow scripts to be passed to front-end? <span class="property-type">(boolean) allowScripts</span></dt>
            <dd>
                If on, any string(s) in <code>msg.script</code> will be dynamically added to the scripts of the web page.
                Turn off to prevent scripts from being dynamically added and executed.
            </dd>
            <dt>Allow styles to be passed to front-end? <span class="property-type">(boolean) allowStyles</span></dt>
            <dd>
                If on, any string(s) in <code>msg.style</code> will be dynamically added to the styles of the web page.
                Turn off to prevent styles from being dynamically added.
            </dd>

            <dt>Copy index.(css|js) from templates to this instance if they don't exist?
                <span class="property-type">(boolean) node-input-copyIndex</span>
            </dt>
            <dd>
                If on (default), index.(css|html|js) files are copied from the master template folder
                if they don't exist in the local assets folder <code>~/.node-red/uibuilder/{url}/src/</code>.
                Turn off if you don't want this to happen (e.g. if you prefer them in a sub-folder).
            </dd>

            <dt>Forward received messages direct to output? <span class="property-type">(boolean) node-input-fwdInMessages</span></dt>
            <dd>
                Forward's a copy of every received message direct to the output.
                Adds the topic from the above setting if one isn't present in the msg.
                <p>
                    <i>Note</i> that this may result in multiple output messages if your front-end
                    code also auto-sends inbound messages.
                </p>
            </dd>
        </dl>

        <h4>Path & Module Info</h4>
        <dl class="message-properties">
            <dt>Web page URL <span class="property-type">(link)</span></dt>
            <dd>
                The web app url for this instance. Click to see the app page.
            </dd>
            <dt>Detailed Information <span class="property-type">(link)</span></dt>
            <dd>
                Shows a web page with detailed information about the overall uibuilder
                configuration. Including details of all of the vendor modules that are
                available and all of the uibuilder endpoints.
            </dd>
        </dl>

    <h3>File/Folder Structure</h3>
    <p>
        For more information, see the GitHub page for <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder" target="_blank">node-red-contrib-uibuilder</a>
    </p>


    <h3>Details</h3>
    <p>
        For more information, see the GitHub page for <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder" target="_blank">node-red-contrib-uibuilder</a>
    </p>
    <p>
        There are also examples of how to use uibuilder in the <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki" target="_blank">GitHub WIKI</a>.
    </p>
    <p>
        uibuilder can be discussed in the <a href="https://discourse.nodered.org/" target="_blank">Node-RED Forum</a> and in the <a href="https://node-red.slack.com/messages/C7K77MG06" target="_blank">Node-RED #uibuilder Slack channel</a>. Issues/bugs can be raised in <a href="https://github.com/TotallyInformation/node-red-contrib-uibuilder/issues" target="_blank">GitHub</a>.
    </p>

    <h3>Admin Index (Details) page</h3>
    <p>
        The <a href="uibindex" target="_blank">&lt;admin url&gt;/uibindex</a> page lists all of the uibuilder endpoints and other details. You can use the following parameters:
    </p>
    <dl class="message-properties">
        <dt>type <span class="property-type">(string)</span></dt>
        <dd>
            The type of the data returned.
            <dl class="message-properties">
                <dt>html <span class="property-type">(default)</span></dt>
                <dd>
                    Also used if no type parameter is given. 
                    Returns an HTML page showing the details for all deployed uibuilder nodes.
                    Shows the server file locations of the instance and for vendor libraries.
                </dd>
                <dt>json</dt>
                <dd>
                    Returns JSON data with both the source node ID's and matching URL's.
                </dd>
                <dt>urls</dt>
                <dd>
                    Returns a JSON array of just the URL's in use from deployed uibuilder nodes.
                    Used internally to ensure that new nodes use unique url's.
                </dd>
            </dl>
        </dd>

        <dt>check <span class="property-type">(string)</span></dt>
        <dd>
            Passing a uibuilder instance name to the check parameter will result in a boolean (true/false)
            return. True if it is being delivered by a uibuilder instance,
            false otherwise. e.g. <code>?check=uibuilder</code>
        </dd>
    </dl>
    <ul>
    </ul>

</script>
