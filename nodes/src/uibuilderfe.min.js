"use strict";if("undefined"!=typeof require&&void 0===io)var io=require("socket.io-client");(function(){var e=this,t=e.uibuilder,o=function(){String.prototype.endsWith||(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)});var n=this;n.version="2.0.7",n.debug=!1,n.moduleName="uibuilder",n.isUnminified=/param/.test(function(e){}),n.uiDebug=function(){n.debug&&console[arguments[0]].apply(console,[].slice.call(arguments,1))},n.me=function(){return!0===n.debug?n:"uibuilderfe.js Version: "+n.version},n.uiDebug("log","\nuibuilderfe: Debug? ",n.debug,"\n\t\tVersion? ",n.version,"\n\t\tRunning Packed version? ",!n.isUnminified,"\n "),n.setIOnamespace=function(){var e="";if(""===(e=document.cookie.replace(/(?:(?:^|.*;\s*)uibuilder-namespace\s*\=\s*([^;]*?).*$)|^.*$/,"$1"))){var t=window.location.pathname.split("/").filter(function(e){return""!==e.trim()});0<t.length&&t[t.length-1].endsWith(".html")&&t.pop(),e=t.join("/"),n.uiDebug("log","uibuilderfe: IO Namespace - Found via url path: "+e)}else n.uiDebug("log","uibuilderfe: IO Namespace - Found via cookie: "+e);return e="/"+e,n.uiDebug("log","uibuilderfe: IO Namespace: "+e),e},n.autoSendReady=!0,n.allowScript=!0,n.allowStyle=!0,n.removeScript=!0,n.removeStyle=!0,n.msg={},n.ctrlMsg={},n.sentMsg={},n.sentCtrlMsg={},n.msgsSent=0,n.msgsReceived=0,n.msgsSentCtrl=0,n.msgsCtrl=0,n.ioConnected=!1,n.serverTimeOffset=null,n.isAuthorised=!1,n.authTokenExpiry=null,n.authData={},n.ioChannels={control:"uiBuilderControl",client:"uiBuilderClient",server:"uiBuilder"},n.retryMs=2e3,n.retryFactor=1.5,n.timerid=null,n.ioNamespace=n.setIOnamespace(),n.ioTransport=["polling","websocket"],n.loaded=!1,n.authToken="";var e=window.location.pathname.split("/").filter(function(e){return""!==e.trim()});return 0<e.length&&e[e.length-1].endsWith(".html")&&e.pop(),n.url=e.pop(),n.httpNodeRoot="/"+e.join("/"),n.ioPath=function(){return("/"+Array.prototype.slice.call(arguments).map(function(e){return e.replace(/^\/|\/$/g,"")}).filter(function(e){return e}).join("/")).replace("//","/")}(n.httpNodeRoot,n.moduleName,"vendor","socket.io"),n.uiDebug("debug","uibuilderfe: ioPath: "+n.ioPath+", httpNodeRoot: "+n.httpNodeRoot+", uibuilder url (not used): "+n.url),n.set=function(e,t){n[e]=t,n.uiDebug("debug","uibuilderfe: prop set - prop: "+e+", val: "+("object"==typeof t)?JSON.stringify(t):t),n.emit(e,t)},n.checkConnect=function(e,t){var o=o++||1;n.uiDebug("debug","uibuilderfe:checkConnect. Reconnect - Depth: "+o+", Delay: "+e+", Factor: "+t,n.ioNamespace,n.ioPath),n.timerid&&window.clearTimeout(n.timerid),n.timerid=window.setTimeout(function(){n.uiDebug("debug","uibuilderfe:checkConnect timeout. SIO reconnect attempt, timeout: "+e+", depth: "+o,n.ioNamespace,n.ioPath),console.info("[uibuilderfe:checkConnect:setTimeout] Socket.IO reconnection attempt. Current delay: "+e),n.socket.close(),n.socket.connect(),n.timerid=null,n.checkConnect(e*t,t)},e)},n.checkTimestamp=function(e){if(e.hasOwnProperty("serverTimestamp")){var t=new Date(e.serverTimestamp),o=Math.round((new Date-t)/36e5);o!==n.serverTimeOffset&&(n.set("serverTimeOffset",o),n.uiDebug("log","uibuilderfe:"+n.ioChannels.server+" (server): Offset changed to: "+o))}},n.ioSetup=function(){n.uiDebug("debug","uibuilderfe:ioSetup: About to create IO. Namespace: "+n.ioNamespace+", Path: "+n.ioPath+", Transport: ["+n.ioTransport.join(", ")+"]"),n.socketOptions={path:n.ioPath,transports:n.ioTransport,transportOptions:{polling:{extraHeaders:{"x-clientid":"uibuilderfe"}}}},n.socket=io(n.ioNamespace,n.socketOptions),n.socket.on("connect",function(){n.uiDebug("info","uibuilderfe:ioSetup: SOCKET CONNECTED - Namespace: "+n.ioNamespace," Server Channel: ",n.ioChannels.server," Control Channel: ",n.ioChannels.control),n.set("ioConnected",!0),n.timerid&&(window.clearTimeout(n.timerid),n.timerid=null)}),n.socket.on(n.ioChannels.server,function(e){n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.server+" (server): msg received - Namespace: "+n.ioNamespace,e),e=i(e,"payload"),n.checkTimestamp(e),n.allowScript&&e.hasOwnProperty("script")&&(n.newScript(e.script),n.removeScript&&delete e.script),n.allowStyle&&e.hasOwnProperty("style")&&(n.newStyle(e.style),n.removeStyle&&delete e.style),n.set("msg",e),n.set("msgsReceived",n.msgsReceived+1)}),n.socket.on(n.ioChannels.control,function(e){if(n.uiDebug("debug","uibuilder:ioSetup:"+n.ioChannels.control+" (control): msg received - Namespace: "+n.ioNamespace,e),null===e)e={};else if("object"!=typeof e){var t={};t["uibuilderCtrl:"+n.ioChannels.control]=e,e=t}switch(e.hasOwnProperty("debug")&&(n.debug=e.debug),n.checkTimestamp(e),n.set("ctrlMsg",e),n.set("msgsCtrl",n.msgsCtrl+1),e.uibuilderCtrl){case"ready for content":e._uibAuth&&n.updateAuth(e._uibAuth),n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "ready for content" from server');break;case"shutdown":n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "shutdown" from server'),n.set("serverShutdown",void 0);break;case"client connect":e._uibAuth&&n.updateAuth(e._uibAuth),!0===n.autoSendReady&&(n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "client connect" from server, auto-sending REPLAY control msg'),n.send({uibuilderCtrl:"ready for content",cacheControl:"REPLAY"},n.ioChannels.control));break;case"authorised":n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "authorised" from server'),console.log("LOGIN SUCCESSFUL",e),e._uibAuth?n.updateAuth(e._uibAuth):(n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "authorised" from server but without a _uibAuth property - logon failed'),console.log("LOGIN SUCCEEDED BUT NO _uibAuth sent",e),n.markLoggedOut("Logon succeeded but no _uibAuth received, logged out"));break;case"authorisation failure":n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "authorisation failure" from server'),console.log("LOGIN FAILED",e),n.markLoggedOut("Logon authorisation failure",e._uibAuth.authData);break;case"logged off":n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "logged off" from server'),console.log("LOGOFF",e),n.markLoggedOut("Logged off by logout() request",e._uibAuth);break;default:n.uiDebug("debug","uibuilderfe:ioSetup:"+n.ioChannels.control+' Received "'+e.uibuilderCtrl+'" from server'),e._uibAuth&&n.updateAuth(e._uibAuth)}}),n.socket.on("disconnect",function(e){n.uiDebug("info","uibuilderfe:ioSetup: SOCKET DISCONNECTED - Namespace: "+n.ioNamespace+", Reason: "+e),n.set("ioConnected",!1),console.warn("[uibuilderfe:socket-disconnect] Reason: "+e),n.checkConnect(n.retryMs,n.retryFactor)}),n.socket.on("connect_error",function(e){n.uiDebug("error","uibuilderfe:ioSetup: SOCKET CONNECT ERROR - Namespace: "+n.ioNamespace+" ioPath: "+n.ioPath+", Reason: "+e.message)}),n.socket.on("error",function(e){n.uiDebug("warn","uibuilderfe:ioSetup: SOCKET ERROR from server - MESSAGE: ",e),n.set("socketError",e)}),n.checkConnect(n.retryMs,n.retryFactor)},n.markLoggedOut=function(e,t){"[object Object]"!==Object.prototype.toString.call(t)&&(t=void 0===t?{}:{message:t}),void 0!==e&&(t.localReason=e),n.authData=t,n.set("isAuthorised",!1),n.authToken="",n.authTokenExpiry=null,n.authData={}},n.updateAuth=function(e){0!==Object.keys(e).length&&(e.authToken?(n.set("isAuthorised",!0),n.authToken=e.authToken,n.authTokenExpiry=e.authTokenExpiry,n.authData=e.authData||{},n.authData.reason=e.reason,n.authData.warning=e.warning):(n.uiDebug("debug","uibuilderfe:updateAuth:"+n.ioChannels.control+' Received "authorised" from server but without a token - logon failed'),console.log("LOGIN SUCCEEDED BUT NO token sent",e),console.trace(),n.markLoggedOut("Logon succeeded but no token received, logged out",e.authData)))},n.addAuthToken=function(e){return"[object Object]"!==Object.prototype.toString.call(e)&&(e={}),n.isAuthorised&&(new Date(n.authTokenExpiry)>new Date?e.authToken=n.authToken:(e.authToken=void 0,n.markLoggedOut("Automatically logged off. Token expired",e.authData))),e},n.send=function(e,t){null==t&&(t=n.ioChannels.client),n.uiDebug("log","uibuilderfe: sending msg - Namespace: "+n.ioNamespace+", Channel: "+t,e),t===n.ioChannels.client?e=i(e,"payload"):t===n.ioChannels.control&&((e=i(e,"uibuilderCtrl")).hasOwnProperty("uibuilderCtrl")||(e.uibuilderCtrl="manual send"),e.from="client"),e._socketId=n.socket.id,e._uibAuth=n.addAuthToken(e._uibAuth),t===n.ioChannels.client?(n.set("sentMsg",e),n.set("msgsSent",n.msgsSent+1)):t===n.ioChannels.control&&(n.set("sentCtrlMsg",e),n.set("msgsSentCtrl",n.msgsSentCtrl+1)),n.socket.emit(t,e)},n.events={},n.emit=function(e){var t=n.events[e];if(t)for(var o=Array.prototype.slice.call(arguments,1),i=0;i<t.length;i++)t[i].apply(n,o)},n.newScript=function(e){if(!0===n.allowScript&&""!==e&&void 0!==e){n.uiDebug("log","uibuilderfe: newCode - script: "+e);var t=document.createElement("script");t.type="text/javascript",t.defer=!0,t.textContent=e,document.getElementsByTagName("body")[0].appendChild(t)}},n.newStyle=function(e){if(!0===n.allowStyle&&""!==e&&void 0!==e){n.uiDebug("log","uibuilderfe: newStyle - style: "+e);var t=document.createElement("style");t.textContent=e,document.getElementsByTagName("head")[0].appendChild(t)}},n.uiReturn={set:function(e,t){if(-1!==["authData","autoSendReady","authToken","authTokenExpiry","ctrlMsg","debug","events","httpNodeRoot","ioChannels","ioConnected","ioNamespace","ioPath","ioTransport","isAuthorised","isUnminified","loaded","msg","msgsCtrl","msgsReceived","msgsSent","msgsSentCtrl","moduleName","retryFactor","retryMs","sentMsg","sentCtrlMsg","serverTimeOffset","socket","timerid","url","version","addAuth","checkConnect","checkTimestamp","emit","get","ioSetup","markLoggedOut","me","newScript","newStyle","onChange","set","send","sendCtrl","socket","self","setIOnamespace","uiDebug","updateAuth","uiReturn"].indexOf(e))return console.warn('[uibuilder] Cannot use set() on protected property "'+e+'"'),void n.uiDebug("warn",'uibuilderfe:uibuilder:set: "'+e+'" is in list of excluded properties, not set');n.set(e,t)},get:function(e){return-1!==["authToken","addAuth","checkConnect","checkTimestamp","emit","get","ioSetup","me","newScript","newStyle","onChange","set","send","sendCtrl","socket","self","setIOnamespace","uiDebug","updateAuth","uiReturn"].indexOf(e)?(console.warn('[uibuilder] Cannot use get() on protected property "'+e+'"'),void n.uiDebug("warn",'uibuilderfe:uibuilder:get: "'+e+'" is in list of excluded properties, not get')):(void 0===n[e]&&console.warn('[uibuilder] get() - property "'+e+'" does not exist'),n[e])},onChange:function(e,t){n.events[e]?n.events[e].push(t):n.events[e]=[t]},msg:n.msg,send:n.send,sendCtrl:function(e){n.send(e,n.ioChannels.control)},autoSendReady:function(e){!0!==e&&(e=!1),n.autoSendReady=e},debug:function(e){if(void 0===e)return n.debug;"boolean"==typeof e&&(n.debug=e)},uiDebug:n.uiDebug,me:n.me,start:function(e,t){void 0!==e&&(n.ioNamespace=e),void 0!==t&&(n.ioPath=t),n.ioSetup()},logon:function(e){void 0===e&&(e={}),n.send({uibuilderCtrl:"logon",from:"client",_uibAuth:e},n.ioChannels.control)},logoff:function(){n.send({uibuilderCtrl:"logoff",from:"client"},n.ioChannels.control)}},window.addEventListener("load",function(){n.uiDebug("debug","uibuilderfe:load: All resources loaded"),n.loaded=!0}),n.uiReturn}.call(e);function i(e,t){null==t&&(t="payload"),"string"!=typeof t&&(console.warn("[uibuilderfe:makeMeAnObject] WARNING: property parameter must be a string and not: "+typeof t),t="payload");var o={};return"object"==typeof e?o=e:null!==e&&(o[t]=e),o}o.noConflict=function(){return e.uibuilder=t,o},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=o),exports.uibuilder=o):e.uibuilder=o}).call(this);